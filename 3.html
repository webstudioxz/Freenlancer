<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda La Reina - Sistema de Gestión</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            position: relative;
            min-height: 100vh;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            position: sticky;
            top: 0;
            background-color: #f5f7fa;
            z-index: 100;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 1.5rem;
        }
        
        .btn {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        /* Panel de almacén */
        .warehouse-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .warehouse-panel.open {
            right: 0;
        }
        
        .close-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* Formularios */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        /* Categorías y productos */
        .category {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .product {
            background-color: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-actions {
            display: flex;
            gap: 5px;
        }
        
        /* Scanner */
        .scanner-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        #scanner-container {
            width: 100%;
            height: 250px;
            background-color: #f1f2f6;
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Carrito de compras */
        .cart {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-total {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #3498db;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* Factura */
        .invoice {
            font-family: 'Courier New', monospace;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .invoice-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .invoice-section {
            margin: 10px 0;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        
        /* Navegación de categorías */
        .categories-nav {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            position: sticky;
            top: 80px;
            background-color: #f5f7fa;
            z-index: 90;
            padding-top: 10px;
        }
        
        .category-btn {
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .category-btn.active {
            background-color: #c0392b;
        }
        
        /* Indicador de escaneo */
        #scan-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 3px;
            background-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            animation: scan 2s infinite ease-in-out;
            display: none;
        }
        
        @keyframes scan {
            0% { top: 20%; }
            50% { top: 80%; }
            100% { top: 20%; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .warehouse-panel {
                width: 300px;
            }
            
            .categories-nav {
                top: 70px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Tienda La Reina - Sistema de Gestión</h1>
        <button id="warehouse-btn" class="btn"><i class="fas fa-warehouse"></i> Almacén</button>
    </header>

    <!-- Navegación de categorías -->
    <div class="categories-nav" id="categories-nav">
        <!-- Las categorías se generarán dinámicamente -->
    </div>

    <main>
        <section class="scanner-section">
            <h2>Escáner de Productos</h2>
            <div id="scanner-container">
                <div class="scanner-overlay" id="scanner-overlay">
                    <p>Haz clic en "Iniciar Escáner" para comenzar</p>
                    <button id="request-camera" class="btn"><i class="fas fa-camera"></i> Permitir Cámara</button>
                </div>
                <video id="scanner-video" playsinline></video>
                <div id="scan-indicator"></div>
            </div>
            <button id="start-scanner" class="btn"><i class="fas fa-barcode"></i> Iniciar Escáner</button>
            <button id="stop-scanner" class="btn btn-danger" style="display:none;"><i class="fas fa-stop"></i> Detener Escáner</button>
        </section>

        <section class="cart">
            <h2>Productos Escaneados</h2>
            <div id="cart-items">
                <!-- Los productos escaneados aparecerán aquí -->
                <p class="empty-cart">No hay productos escaneados</p>
            </div>
            <div class="cart-total">
                Total: $<span id="total-amount">0.00</span>
            </div>
            <button id="print-invoice" class="btn btn-success" style="margin-top: 15px; display: none;"><i class="fas fa-receipt"></i> Imprimir Factura</button>
        </section>
    </main>

    <!-- Panel de Almacén -->
    <div class="warehouse-panel" id="warehouse-panel">
        <button class="close-panel" id="close-panel">&times;</button>
        <h2>Gestión de Almacén</h2>
        
        <div class="form-group">
            <h3>Agregar Categoría</h3>
            <input type="text" id="new-category-name" placeholder="Nombre de categoría">
            <button id="add-category" class="btn" style="margin-top: 10px;"><i class="fas fa-plus"></i> Agregar Categoría</button>
        </div>
        
        <div id="categories-container">
            <!-- Las categorías se mostrarán aquí -->
        </div>
    </div>

    <!-- Modal para editar producto -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Producto</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit-product-name">Nombre:</label>
                <input type="text" id="edit-product-name">
            </div>
            <div class="form-group">
                <label for="edit-product-price">Precio:</label>
                <input type="number" id="edit-product-price" step="0.01">
            </div>
            <div class="form-group">
                <label for="edit-product-quantity">Cantidad:</label>
                <input type="number" id="edit-product-quantity">
            </div>
            <button id="save-product-changes" class="btn btn-success">Guardar Cambios</button>
        </div>
    </div>

    <!-- Modal de factura -->
    <div class="modal" id="invoice-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Factura de Venta</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="invoice" id="invoice-content">
                <!-- La factura se generará aquí -->
            </div>
            <button id="confirm-sale" class="btn btn-success" style="margin-top: 20px; width: 100%;">Confirmar Venta</button>
        </div>
    </div>

    <script>
        // Datos de ejemplo
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            {
                id: 1,
                name: 'Liquidos',
                products: [
                    { id: 101, name: 'Jugo de Naranja', price: 175, quantity: 20, initialQuantity: 20 },
                    { id: 102, name: 'Agua Mineral', price: 100, quantity: 15, initialQuantity: 15 }
                ]
            },
            {
                id: 2,
                name: 'Confituras',
                products: [
                    { id: 201, name: 'Mermelada de Fresa', price: 125, quantity: 30, initialQuantity: 30 },
                    { id: 202, name: 'Mermelada de Durazno', price: 130, quantity: 25, initialQuantity: 25 }
                ]
            }
        ];

        // Carrito de compras
        let cart = [];
        let currentScanner = null;
        let editingProduct = null;
        let stream = null;
        let quaggaInitialized = false;

        // Elementos del DOM
        const warehouseBtn = document.getElementById('warehouse-btn');
        const warehousePanel = document.getElementById('warehouse-panel');
        const closePanelBtn = document.getElementById('close-panel');
        const categoriesNav = document.getElementById('categories-nav');
        const categoriesContainer = document.getElementById('categories-container');
        const newCategoryName = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category');
        const startScannerBtn = document.getElementById('start-scanner');
        const stopScannerBtn = document.getElementById('stop-scanner');
        const requestCameraBtn = document.getElementById('request-camera');
        const scannerVideo = document.getElementById('scanner-video');
        const scannerOverlay = document.getElementById('scanner-overlay');
        const scanIndicator = document.getElementById('scan-indicator');
        const cartItems = document.getElementById('cart-items');
        const totalAmount = document.getElementById('total-amount');
        const printInvoiceBtn = document.getElementById('print-invoice');
        const editProductModal = document.getElementById('edit-product-modal');
        const invoiceModal = document.getElementById('invoice-modal');
        const invoiceContent = document.getElementById('invoice-content');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const saveProductChangesBtn = document.getElementById('save-product-changes');
        const confirmSaleBtn = document.getElementById('confirm-sale');

        // Inicializar la aplicación
        function init() {
            renderCategoriesNav();
            renderCategories();
            updateCartUI();
            
            // Event listeners
            warehouseBtn.addEventListener('click', toggleWarehousePanel);
            closePanelBtn.addEventListener('click', toggleWarehousePanel);
            addCategoryBtn.addEventListener('click', addNewCategory);
            startScannerBtn.addEventListener('click', startScanner);
            stopScannerBtn.addEventListener('click', stopScanner);
            requestCameraBtn.addEventListener('click', requestCameraPermission);
            printInvoiceBtn.addEventListener('click', showInvoice);
            saveProductChangesBtn.addEventListener('click', saveProductChanges);
            confirmSaleBtn.addEventListener('click', confirmSale);
            
            // Cerrar modales
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Cerrar modal haciendo clic fuera de él
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // Guardar datos al cerrar la página
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('categories', JSON.stringify(categories));
                if (stream) {
                    stopScanner();
                }
            });
        }

        // Mostrar/ocultar panel de almacén
        function toggleWarehousePanel() {
            warehousePanel.classList.toggle('open');
        }

        // Renderizar navegación de categorías
        function renderCategoriesNav() {
            categoriesNav.innerHTML = '';
            
            // Agregar botón para mostrar todos
            const allButton = document.createElement('button');
            allButton.className = 'category-btn active';
            allButton.textContent = 'Todos';
            allButton.addEventListener('click', () => filterProductsByCategory(null));
            categoriesNav.appendChild(allButton);
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category.name;
                button.addEventListener('click', () => filterProductsByCategory(category.id));
                categoriesNav.appendChild(button);
            });
        }

        // Filtrar productos por categoría
        function filterProductsByCategory(categoryId) {
            // Cambiar clase activa en botones
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (categoryId === null) {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.textContent === 'Todos') btn.classList.add('active');
                });
                renderCategories();
            } else {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.textContent === categories.find(c => c.id === categoryId).name) btn.classList.add('active');
                });
                
                categoriesContainer.innerHTML = '';
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'category';
                    
                    categoryElement.innerHTML = `
                        <div class="category-header">
                            <h3>${category.name}</h3>
                        </div>
                        <div id="products-${category.id}">
                            ${renderProducts(category)}
                        </div>
                    `;
                    
                    categoriesContainer.appendChild(categoryElement);
                }
            }
        }

        // Renderizar categorías y productos
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            
            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category';
                
                categoryElement.innerHTML = `
                    <div class="category-header">
                        <h3>${category.name}</h3>
                        <button class="btn btn-danger" onclick="deleteCategory(${category.id})"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="form-group">
                        <input type="text" id="product-name-${category.id}" placeholder="Nombre del producto">
                        <input type="number" id="product-price-${category.id}" placeholder="Precio" step="0.01">
                        <input type="number" id="product-quantity-${category.id}" placeholder="Cantidad">
                        <button class="btn" onclick="addProductToCategory(${category.id})" style="margin-top: 10px;"><i class="fas fa-plus"></i> Agregar Producto</button>
                    </div>
                    <div id="products-${category.id}">
                        ${renderProducts(category)}
                    </div>
                `;
                
                categoriesContainer.appendChild(categoryElement);
            });
            
            // Guardar en localStorage después de renderizar
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        // Renderizar productos de una categoría
        function renderProducts(category) {
            if (category.products.length === 0) {
                return '<p>No hay productos en esta categoría</p>';
            }
            
            return category.products.map(product => `
                <div class="product">
                    <div class="product-info">
                        <strong>${product.name}</strong> - $${product.price.toFixed(2)} 
                        <br> Cantidad: ${product.quantity}/${product.initialQuantity}
                        <br> Código: ${product.id}
                    </div>
                    <div class="product-actions">
                        <button class="btn" onclick="editProduct(${category.id}, ${product.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteProduct(${category.id}, ${product.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // Agregar nueva categoría
        function addNewCategory() {
            const name = newCategoryName.value.trim();
            if (!name) return;
            
            const newCategory = {
                id: Date.now(),
                name: name,
                products: []
            };
            
            categories.push(newCategory);
            newCategoryName.value = '';
            renderCategoriesNav();
            renderCategories();
        }

        // Eliminar categoría
        function deleteCategory(categoryId) {
            if (confirm('¿Estás seguro de que quieres eliminar esta categoría y todos sus productos?')) {
                categories = categories.filter(cat => cat.id !== categoryId);
                renderCategoriesNav();
                renderCategories();
            }
        }

        // Agregar producto a categoría
        function addProductToCategory(categoryId) {
            const category = categories.find(cat => cat.id === categoryId);
            if (!category) return;
            
            const name = document.getElementById(`product-name-${categoryId}`).value.trim();
            const price = parseFloat(document.getElementById(`product-price-${categoryId}`).value);
            const quantity = parseInt(document.getElementById(`product-quantity-${categoryId}`).value);
            
            if (!name || isNaN(price) || isNaN(quantity)) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }
            
            const newProduct = {
                id: Date.now(),
                name: name,
                price: price,
                quantity: quantity,
                initialQuantity: quantity
            };
            
            category.products.push(newProduct);
            
            // Limpiar campos
            document.getElementById(`product-name-${categoryId}`).value = '';
            document.getElementById(`product-price-${categoryId}`).value = '';
            document.getElementById(`product-quantity-${categoryId}`).value = '';
            
            renderCategories();
        }

        // Editar producto
        function editProduct(categoryId, productId) {
            const category = categories.find(cat => cat.id === categoryId);
            if (!category) return;
            
            const product = category.products.find(p => p.id === productId);
            if (!product) return;
            
            editingProduct = { categoryId, productId };
            
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-quantity').value = product.quantity;
            
            editProductModal.style.display = 'flex';
        }

        // Guardar cambios en producto
        function saveProductChanges() {
            if (!editingProduct) return;
            
            const category = categories.find(cat => cat.id === editingProduct.categoryId);
            if (!category) return;
            
            const product = category.products.find(p => p.id === editingProduct.productId);
            if (!product) return;
            
            const newName = document.getElementById('edit-product-name').value;
            const newPrice = parseFloat(document.getElementById('edit-product-price').value);
            const newQuantity = parseInt(document.getElementById('edit-product-quantity').value);
            
            if (!newName || isNaN(newPrice) || isNaN(newQuantity)) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }
            
            // Actualizar producto
            product.name = newName;
            product.price = newPrice;
            
            // Ajustar la cantidad inicial si la cantidad actual es mayor
            if (newQuantity > product.initialQuantity) {
                product.initialQuantity = newQuantity;
            }
            
            product.quantity = newQuantity;
            
            editProductModal.style.display = 'none';
            renderCategories();
        }

        // Eliminar producto
        function deleteProduct(categoryId, productId) {
            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                const category = categories.find(cat => cat.id === categoryId);
                if (!category) return;
                
                category.products = category.products.filter(p => p.id !== productId);
                renderCategories();
            }
        }

        // Solicitar permiso para usar la cámara
        function requestCameraPermission() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    scannerVideo.srcObject = stream;
                    scannerOverlay.style.display = 'none';
                    startScannerBtn.style.display = 'none';
                    stopScannerBtn.style.display = 'inline-block';
                    
                    // Iniciar Quagga.js para escanear códigos de barras
                    initQuagga();
                })
                .catch(function(error) {
                    alert('No se pudo acceder a la cámara: ' + error.message);
                    // Mostrar opción de entrada manual
                    simulateManualScan();
                });
        }

        // Inicializar Quagga.js para escanear códigos de barras
        function initQuagga() {
            if (quaggaInitialized) return;
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerVideo,
                    constraints: {
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error("Error al inicializar Quagga:", err);
                    alert("No se pudo inicializar el escáner. Usando modo manual.");
                    simulateManualScan();
                    return;
                }
                
                quaggaInitialized = true;
                Quagga.start();
                
                // Mostrar indicador de escaneo
                scanIndicator.style.display = 'block';
                
                // Detectar cuando se escanea un código
                Quagga.onDetected(function(result) {
                    const code = result.codeResult.code;
                    processScannedCode(code);
                });
            });
        }

        // Procesar código escaneado
        function processScannedCode(code) {
            // Buscar el producto en todas las categorías
            for (const category of categories) {
                const product = category.products.find(p => p.id == code);
                if (product) {
                    addToCart(product, category.name);
                    
                    // Efecto visual de éxito
                    scanIndicator.style.backgroundColor = '#2ecc71';
                    setTimeout(() => {
                        scanIndicator.style.backgroundColor = '#3498db';
                    }, 500);
                    
                    return;
                }
            }
            
            // Código no encontrado
            scanIndicator.style.backgroundColor = '#e74c3c';
            setTimeout(() => {
                scanIndicator.style.backgroundColor = '#3498db';
            }, 500);
            
            alert('Producto no encontrado con código: ' + code);
        }

        // Simular entrada manual de código (para dispositivos sin cámara)
        function simulateManualScan() {
            scannerOverlay.innerHTML = `
                <p>Ingresa el código del producto:</p>
                <input type="number" id="manual-code-input" style="padding: 10px; width: 150px; font-size: 18px; text-align: center;">
                <button class="btn" onclick="processManualCode()">Agregar Producto</button>
            `;
            scannerOverlay.style.display = 'flex';
        }

        // Procesar código manual
        function processManualCode() {
            const codeInput = document.getElementById('manual-code-input');
            const code = parseInt(codeInput.value);
            
            if (isNaN(code)) {
                alert('Por favor ingresa un código válido');
                return;
            }
            
            processScannedCode(code);
            codeInput.value = '';
        }

        // Iniciar escáner
        function startScanner() {
            if (!stream) {
                requestCameraPermission();
                return;
            }
            
            scannerOverlay.style.display = 'none';
            startScannerBtn.style.display = 'none';
            stopScannerBtn.style.display = 'inline-block';
            
            if (quaggaInitialized) {
                Quagga.start();
                scanIndicator.style.display = 'block';
            }
        }

        // Detener escáner
        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (quaggaInitialized) {
                Quagga.stop();
                scanIndicator.style.display = 'none';
            }
            
            scannerVideo.srcObject = null;
            scannerOverlay.innerHTML = `
                <p>Haz clic en "Iniciar Escáner" para comenzar</p>
                <button id="request-camera" class="btn"><i class="fas fa-camera"></i> Permitir Cámara</button>
            `;
            scannerOverlay.style.display = 'flex';
            startScannerBtn.style.display = 'inline-block';
            stopScannerBtn.style.display = 'none';
            
            // Reasignar el event listener al nuevo botón
            document.getElementById('request-camera').addEventListener('click', requestCameraPermission);
        }

        // Agregar producto al carrito
        function addToCart(product, categoryName) {
            // Verificar si hay suficiente stock
            if (product.quantity <= 0) {
                alert('No hay suficiente stock de este producto');
                return;
            }
            
            // Verificar si el producto ya está en el carrito
            const existingItem = cart.find(item => item.product.id === product.id);
            
            if (existingItem) {
                // Verificar si hay suficiente stock para agregar más
                if (existingItem.quantity >= product.quantity) {
                    alert('No hay suficiente stock para agregar más unidades de este producto');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({
                    product: product,
                    category: categoryName,
                    quantity: 1
                });
            }
            
            updateCartUI();
        }

        // Actualizar interfaz del carrito
        function updateCartUI() {
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="empty-cart">No hay productos escaneados</p>';
                printInvoiceBtn.style.display = 'none';
            } else {
                cartItems.innerHTML = '';
                cart.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cart-item';
                    itemElement.innerHTML = `
                        <div>
                            <strong>${item.product.name}</strong> (${item.category})<br>
                            $${item.product.price.toFixed(2)} x ${item.quantity}
                        </div>
                        <div>
                            $${(item.product.price * item.quantity).toFixed(2)}
                            <button class="btn btn-danger" onclick="removeFromCart(${index})" style="margin-left: 10px;"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    cartItems.appendChild(itemElement);
                });
                printInvoiceBtn.style.display = 'block';
            }
            
            // Calcular total
            const total = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            totalAmount.textContent = total.toFixed(2);
        }

        // Eliminar producto del carrito
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
        }

        // Mostrar factura
        function showInvoice() {
            invoiceContent.innerHTML = '';
            
            const invoice = document.createElement('div');
            invoice.innerHTML = `
                <div class="invoice-header">Tienda La Reina</div>
                <div>${new Date().toLocaleString()}</div>
            `;
            
            // Agrupar productos por categoría
            const productsByCategory = {};
            cart.forEach(item => {
                if (!productsByCategory[item.category]) {
                    productsByCategory[item.category] = [];
                }
                productsByCategory[item.category].push(item);
            });
            
            // Generar líneas de la factura por categoría
            Object.keys(productsByCategory).forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'invoice-section';
                categorySection.innerHTML = `<div class="invoice-line"><strong>Categoría: ${category}</strong></div>`;
                
                productsByCategory[category].forEach(item => {
                    categorySection.innerHTML += `
                        <div class="invoice-line">
                            <span>${item.product.name}</span>
                            <span>${item.quantity} x $${item.product.price}</span>
                        </div>
                        <div class="invoice-line">
                            <span></span>
                            <span>$${(item.product.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `;
                });
                
                invoice.appendChild(categorySection);
            });
            
            // Total
            const totalSection = document.createElement('div');
            totalSection.className = 'invoice-section';
            totalSection.innerHTML = `
                <div class="invoice-line">
                    <strong>Total:</strong>
                    <strong>$${totalAmount.textContent}</strong>
                </div>
            `;
            invoice.appendChild(totalSection);
            
            // Mensaje de agradecimiento
            const thanks = document.createElement('div');
            thanks.style.textAlign = 'center';
            thanks.style.marginTop = '15px';
            thanks.innerHTML = `
                <div>Gracias por su servicio</div>
                <div>Vuelva pronto</div>
            `;
            invoice.appendChild(thanks);
            
            invoiceContent.appendChild(invoice);
            invoiceModal.style.display = 'flex';
        }

        // Confirmar venta y actualizar inventario
        function confirmSale() {
            // Actualizar cantidades en el inventario
            cart.forEach(item => {
                const category = categories.find(cat => cat.name === item.category);
                if (category) {
                    const product = category.products.find(p => p.id === item.product.id);
                    if (product) {
                        product.quantity -= item.quantity;
                    }
                }
            });
            
            // Limpiar carrito
            cart = [];
            updateCartUI();
            
            // Actualizar vista de categorías
            renderCategories();
            
            // Cerrar modal
            invoiceModal.style.display = 'none';
            
            alert('Venta registrada correctamente. El inventario ha sido actualizado.');
        }

        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
        
        // Hacer funciones disponibles globalmente para los eventos onclick
        window.toggleWarehousePanel = toggleWarehousePanel;
        window.addNewCategory = addNewCategory;
        window.deleteCategory = deleteCategory;
        window.addProductToCategory = addProductToCategory;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.startScanner = startScanner;
        window.stopScanner = stopScanner;
        window.requestCameraPermission = requestCameraPermission;
        window.processManualCode = processManualCode;
        window.removeFromCart = removeFromCart;
        window.showInvoice = showInvoice;
    </script>
</body>
</html>