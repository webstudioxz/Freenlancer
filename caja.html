
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda La Reina - Sistema de Gestión</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* ESTILOS EXISTENTES (sin cambios) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            position: sticky;
            top: 0;
            background-color: #f5f7fa;
            z-index: 100;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 1.5rem;
        }
        
        .btn {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        /* Panel de almacén */
        .warehouse-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .warehouse-panel.open {
            right: 0;
        }
        
        /* Panel de cierre de caja */
        .cashier-panel {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100vh;
            background-color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .cashier-panel.open {
            left: 0;
        }
        
        .close-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* Formularios */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        /* Categorías y productos */
        .category {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .product {
            background-color: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-actions {
            display: flex;
            gap: 5px;
        }
        
        /* Scanner */
        .scanner-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        #scanner-container {
            width: 100%;
            height: 250px;
            background-color: #f1f2f6;
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Factura de venta */
        .invoice-panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            transform: translateY(100%);
            transition: transform 0.5s ease;
            max-height: 0;
            overflow: hidden;
            display: none; /* MODIFICACIÓN: Ocultar factura inicialmente */
        }
        
        .invoice-panel.open {
            transform: translateY(0);
            max-height: 1000px;
            display: block; /* MODIFICACIÓN: Mostrar factura cuando tenga productos */
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-total {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #3498db;
        }
        
        /* Sección de pago */
        .payment-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .payment-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .payment-result {
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* Factura */
        .invoice {
            font-family: 'Courier New', monospace;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .invoice-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .invoice-section {
            margin: 10px 0;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        
        /* Navegación de categorías */
        .categories-nav {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            position: sticky;
            top: 80px;
            background-color: #f5f7fa;
            z-index: 90;
            padding-top: 10px;
        }
        
        .category-btn {
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .category-btn.active {
            background-color: #c0392b;
        }
        
        /* Indicador de escaneo */
        #scan-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 3px;
            background-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            animation: scan 2s infinite ease-in-out;
            display: none;
        }
        
        @keyframes scan {
            0% { top: 20%; }
            50% { top: 80%; }
            100% { top: 20%; }
        }
        
        /* Tablas para cierre de caja */
        .cashier-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .cashier-table th, .cashier-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .cashier-table th {
            background-color: #f2f2f2;
        }
        
        .cashier-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .cashier-table input {
            width: 80px;
            padding: 5px;
            text-align: center;
        }
        
        .cashier-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        /* Navegación de productos en inventario */
        .product-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .product-display {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .warehouse-panel, .cashier-panel {
                width: 100%;
            }
            
            .categories-nav {
                top: 70px;
            }
            
            .product-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .product-navigation button {
                width: 100%;
            }
        }
        
        /* Estilos para entrada manual de código */
        .manual-input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        
        .manual-input-container input {
            flex: 1;
        }
        
        /* Mejoras para el panel de cierre de caja */
        .inventory-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .category-detail {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .category-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .product-detail {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 14px;
        }
        
        .product-detail span {
            flex: 1;
            text-align: center;
        }
        
        .product-detail .product-name {
            text-align: left;
            flex: 2;
        }
        
        /* Estilos para la pestaña de agregar productos */
        .category-tab {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .add-product-form {
            display: none;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        /* Estilos para el control de cantidad manual */
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .quantity-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }

        /* Nuevos estilos para el desglose de cierre de caja */
        .category-breakdown {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .category-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
            color: #2c3e50;
        }
        
        .product-breakdown {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .product-breakdown.header {
            font-weight: bold;
            background-color: #eef2f7;
            padding: 10px 0;
            border-radius: 4px;
        }
        
        .breakdown-column {
            flex: 1;
            text-align: center;
        }
        
        .breakdown-name {
            flex: 2;
            text-align: left;
        }
        
        .category-total {
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            text-align: right;
        }
        
        .divider {
            height: 1px;
            background-color: #ddd;
            margin: 10px 0;
        }

        /* Colores para categorías */
        .category-color-1 { color: #e74c3c; } /* Rojo */
        .category-color-2 { color: #3498db; } /* Azul */
        .category-color-3 { color: #2ecc71; } /* Verde */
        .category-color-4 { color: #f39c12; } /* Naranja */
        .category-color-5 { color: #9b59b6; } /* Púrpura */
        .category-color-6 { color: #1abc9c; } /* Turquesa */
        .category-color-7 { color: #d35400; } /* Calabaza */
        .category-color-8 { color: #c0392b; } /* Rojo oscuro */

        /* Nuevos estilos para el botón de PDF */
        .btn-pdf {
            background-color: #e74c3c;
            margin-top: 10px;
        }
        
        .btn-pdf:hover {
            background-color: #c0392b;
        }
        
        /* Nuevos estilos para el botón de reset de efectivo */
        .btn-cash-reset {
            background-color: #7f8c8d;
            margin-top: 10px;
        }
        
        .btn-cash-reset:hover {
            background-color: #636e72;
        }
        
        /* Nuevos estilos para WhatsApp */
        .btn-whatsapp {
            background-color: #25D366;
            margin-top: 10px;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
        }
        
        .whatsapp-input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        
        .whatsapp-input-container input {
            flex: 1;
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
        
        .whatsapp-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Tienda La Reina - Sistema de Gestión</h1>
        <div>
            <button id="cashier-btn" class="btn btn-warning"><i class="fas fa-cash-register"></i> Cierre de Caja</button>
            <button id="warehouse-btn" class="btn"><i class="fas fa-warehouse"></i> Inventario</button>
        </div>
    </header>

    <main>
        <section class="scanner-section">
            <h2>Escáner de Productos</h2>
            <div id="scanner-container">
                <div class="scanner-overlay" id="scanner-overlay">
                    <p>Haz clic en "Iniciar Escáner" para comenzar</p>
                    <button id="request-camera" class="btn"><i class="fas fa-camera"></i> Permitir Cámara</button>
                </div>
                <video id="scanner-video" playsinline></video>
                <div id="scan-indicator"></div>
            </div>
            <button id="start-scanner" class="btn"><i class="fas fa-barcode"></i> Iniciar Escáner</button>
            <button id="stop-scanner" class="btn btn-danger" style="display:none;"><i class="fas fa-stop"></i> Detener Escáner</button>
            
            <!-- Entrada manual de código -->
            <div class="manual-input-container">
                <input type="text" id="manual-code-input" placeholder="Ingresar código manualmente">
                <div class="quantity-controls">
                    <button class="btn quantity-btn" id="decrease-quantity">-</button>
                    <span class="quantity-display" id="manual-quantity">1</span>
                    <button class="btn quantity-btn" id="increase-quantity">+</button>
                </div>
                <button id="add-manual-code" class="btn"><i class="fas fa-keyboard"></i> Agregar</button>
            </div>
        </section>

        <!-- Factura de venta (reemplaza al carrito) -->
        <section class="invoice-panel" id="invoice-panel">
            <h2>Factura de Venta</h2>
            <div id="invoice-items">
                <!-- Los productos agregados aparecerán aquí -->
                <p class="empty-invoice">No hay productos en la factura</p>
            </div>
            <div class="invoice-total">
                Total: $<span id="total-amount">0.00</span>
            </div>
            
            <!-- Sección de pago -->
            <div class="payment-section">
                <h3>Pago</h3>
                <div class="payment-input">
                    <label for="amount-received">Monto recibido:</label>
                    <input type="number" id="amount-received" step="0.01" placeholder="0.00">
                    <button id="calculate-change" class="btn">Calcular Cambio</button>
                </div>
                <div id="change-result" class="payment-result">
                    Cambio a devolver: $<span id="change-amount">0.00</span>
                </div>
            </div>
            
            <button id="confirm-sale" class="btn btn-success" style="margin-top: 15px; width: 100%;"><i class="fas fa-check"></i> Confirmar Venta</button>
            <button id="reset-invoice" class="btn btn-danger" style="margin-top: 15px; width: 100%;"><i class="fas fa-sync"></i> Reiniciar Factura</button>
        </section>
    </main>

    <!-- Panel de Almacén -->
    <div class="warehouse-panel" id="warehouse-panel">
        <button class="close-panel" id="close-warehouse-panel">&times;</button>
        <h2>Gestión de Inventario</h2>
        
        <!-- Navegación de categorías -->
        <div class="categories-nav" id="categories-nav">
            <!-- Las categorías se generarán dinámicamente -->
        </div>
        
        <!-- Visualización del producto actual -->
        <div class="product-display" id="product-display" style="display: none;">
            <h3 id="current-product-name">Nombre del Producto</h3>
            <p>Precio: $<span id="current-product-price">0.00</span></p>
            <p>Cantidad: <span id="current-product-quantity">0</span></p>
            <p>Categoría: <span id="current-product-category">Categoría</span></p>
            <p>Código: <span id="current-product-code">0000</span></p>
        </div>
        
        <div class="form-group">
            <h3>Agregar Categoría</h3>
            <input type="text" id="new-category-name" placeholder="Nombre de categoría">
            <button id="add-category" class="btn" style="margin-top: 10px;"><i class="fas fa-plus"></i> Agregar Categoría</button>
        </div>
        
        <div id="categories-container">
            <!-- Las categorías se mostrarán aquí -->
        </div>
    </div>

    <!-- Panel de Cierre de Caja -->
    <div class="cashier-panel" id="cashier-panel">
        <button class="close-panel" id="close-cashier-panel">&times;</button>
        <h2>Cierre de Caja</h2>
        
        <!-- Nuevo campo para el nombre del cajero -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="cashier-name">Nombre de quien realiza el cierre:</label>
            <input type="text" id="cashier-name" placeholder="Ingrese su nombre">
        </div>
        
        <!-- Detalles de inventario por producto - NUEVA SECCIÓN -->
        <div class="inventory-details">
            <h3>Desglose de Productos por Categoría</h3>
            <div id="category-breakdown">
                <!-- El desglose por categoría se generará aquí -->
            </div>
            
            <!-- BOTÓN PARA IMPRIMIR PDF - NUEVO -->
            <button id="print-category-pdf" class="btn btn-pdf" style="margin-top: 15px;">
                <i class="fas fa-file-pdf"></i> Imprimir PDF de Desglose
            </button>
        </div>
        
        <!-- Detalles de inventario por producto -->
        <div class="inventory-details">
            <h3>Productos Vendidos</h3>
            <div id="inventory-details-content">
                <!-- Los detalles se llenarán dinámicamente -->
            </div>
            
            <button id="reset-breakdown" class="btn btn-warning" style="margin-top: 20px;">
                <i class="fas fa-sync"></i> Restablecer Desglose
            </button>
        </div>
        
        <br>
        <br>
        <br>
        
        <h3>Desglose de Efectivo</h3>
        
        <!-- Botón específico para restablecer solo el desglose de efectivo -->
        <button id="reset-cash-breakdown" class="btn btn-cash-reset">
            <i class="fas fa-coins"></i> Restablecer Desglose de Efectivo
        </button>
        
        <table class="cashier-table" id="cash-breakdown">
            <thead>
                <tr>
                    <th>Denominación</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>$1000</td>
                    <td><input type="number" min="0" id="bill-1000" value="0" class="cash-input"></td>
                    <td id="total-1000">$0.00</td>
                </tr>
                <tr>
                    <td>$500</td>
                    <td><input type="number" min="0" id="bill-500" value="0" class="cash-input"></td>
                    <td id="total-500">$0.00</td>
                </tr>
                <tr>
                    <td>$200</td>
                    <td><input type="number" min="0" id="bill-200" value="0" class="cash-input"></td>
                    <td id="total-200">$0.00</td>
                </tr>
                <tr>
                    <td>$100</td>
                    <td><input type="number" min="0" id="bill-100" value="0" class="cash-input"></td>
                    <td id="total-100">$0.00</td>
                </tr>
                <tr>
                    <td>$50</td>
                    <td><input type="number" min="0" id="bill-50" value="0" class="cash-input"></td>
                    <td id="total-50">$0.00</td>
                </tr>
                <tr>
                    <td>$20</td>
                    <td><input type="number" min="0" id="bill-20" value="0" class="cash-input"></td>
                    <td id="total-20">$0.00</td>
                </tr>
                <tr>
                    <td>Monedas $10</td>
                    <td><input type="number" min="0" id="coin-10" value="0" class="cash-input"></td>
                    <td id="total-coin-10">$0.00</td>
                </tr>
                <tr>
                    <td>Monedas $5</td>
                    <td><input type="number" min="0" id="coin-5" value="0" class="cash-input"></td>
                    <td id="total-coin-5">$0.00</td>
                </tr>
                <tr>
                    <td>Monedas $1</td>
                    <td><input type="number" min="0" id="coin-1" value="0" class="cash-input"></td>
                    <td id="total-coin-1">$0.00</td>
                </tr>
            </tbody>
        </table>
        
        <div class="cashier-summary">
            <h3>Resumen de Cierre</h3>
            <p>Total en Efectivo: $<span id="total-cash">0.00</span></p>
            <p>Total de Ventas: $<span id="total-sales">0.00</span></p>
            <p>Diferencia: $<span id="cash-difference">0.00</span></p>
        </div>
        
        <button id="print-report" class="btn"><i class="fas fa-print"></i> Imprimir Reporte</button>
        
        <!-- BOTÓN DE WHATSAPP MOVIDO AQUÍ (debajo de Imprimir Reporte) -->
        <button id="send-whatsapp" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> Enviar Cierre de Caja por WhatsApp</button>
        <div class="whatsapp-info">
            Se enviará el reporte de cierre de caja en formato PDF al número configurado.
        </div>
        
        <button id="close-cashier" class="btn btn-danger"><i class="fas fa-times"></i> Cerrar Caja</button>
        
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
    </div>
          
    <!-- Modal para editar producto -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Producto</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit-product-name">Nombre:</label>
                <input type="text" id="edit-product-name">
            </div>
            <div class="form-group">
                <label for="edit-product-price">Precio:</label>
                <input type="number" id="edit-product-price" step="0.01">
            </div>
            <div class="form-group">
                <label for="edit-product-quantity">Cantidad:</label>
                <input type="number" id="edit-product-quantity">
            </div>
            <div class="form-group">
                <label for="edit-product-category">Categoría:</label>
                <select id="edit-product-category">
                    <!-- Las opciones se llenarán dinámicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="edit-product-code">Código:</label>
                <input type="text" id="edit-product-code">
            </div>
            <button id="save-product-changes" class="btn btn-success">Guardar Cambios</button>
        </div>
    </div>

    <!-- Modal de factura para impresión -->
    <div class="modal" id="invoice-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Factura de Venta</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="invoice" id="invoice-content">
                <!-- La factura se generará aquí -->
            </div>
            <button id="print-invoice" class="btn btn-success" style="margin-top: 20px; width: 100%;"><i class="fas fa-print"></i> Imprimir Factura</button>
        </div>
    </div>

    <script>
        // =============================================================================
        // SECCIÓN 1: VARIABLES GLOBALES Y CONSTANTES
        // =============================================================================
        
        // Almacenamiento de datos de la aplicación
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            {
                id: 1,
                name: 'Liquidos',
                products: [
                    { id: 'CER001', name: 'Cerveza', price: 175, quantity: 50, initialQuantity: 60 },
                    { id: 'REF001', name: 'Refresco', price: 100, quantity: 9, initialQuantity: 10 }
                ]
            },
            {
                id: 2,
                name: 'Confituras',
                products: [
                    { id: 'GAL001', name: 'Galletas', price: 125, quantity: 50, initialQuantity: 100 },
                    { id: 'GEL001', name: 'Gelatina', price: 130, quantity: 20, initialQuantity: 30 }
                ]
            }
        ];

        // Factura de venta (reemplaza al carrito)
        let invoiceItems = [];
        let currentScanner = null;
        let editingProduct = null;
        let stream = null;
        let quaggaInitialized = false;
        let currentProductIndex = 0;
        let currentCategoryIndex = 0;
        let allProducts = [];
        let manualQuantity = 1;

        // Variables para el desglose de efectivo
        let cashBreakdown = JSON.parse(localStorage.getItem('cashBreakdown')) || {
            'bill-1000': 0,
            'bill-500': 0,
            'bill-200': 0,
            'bill-100': 0,
            'bill-50': 0,
            'bill-20': 0,
            'coin-10': 0,
            'coin-5': 0,
            'coin-1': 0
        };

        // Número de WhatsApp configurado internamente (MODIFICACIÓN: número fijo)
        const whatsappNumber = "+5353571569"; // Cambiar por el número deseado

        // =============================================================================
        // SECCIÓN 2: ELEMENTOS DEL DOM
        // =============================================================================
        
        // Elementos de navegación y paneles
        const warehouseBtn = document.getElementById('warehouse-btn');
        const cashierBtn = document.getElementById('cashier-btn');
        const warehousePanel = document.getElementById('warehouse-panel');
        const cashierPanel = document.getElementById('cashier-panel');
        const closeWarehousePanelBtn = document.getElementById('close-warehouse-panel');
        const closeCashierPanelBtn = document.getElementById('close-cashier-panel');
        const categoriesNav = document.getElementById('categories-nav');
        const categoriesContainer = document.getElementById('categories-container');
        
        // Elementos de categorías
        const newCategoryName = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category');
        
        // Elementos del escáner
        const startScannerBtn = document.getElementById('start-scanner');
        const stopScannerBtn = document.getElementById('stop-scanner');
        const requestCameraBtn = document.getElementById('request-camera');
        const scannerVideo = document.getElementById('scanner-video');
        const scannerOverlay = document.getElementById('scanner-overlay');
        const scanIndicator = document.getElementById('scan-indicator');
        
        // Elementos de la factura
        const invoiceItemsContainer = document.getElementById('invoice-items');
        const totalAmount = document.getElementById('total-amount');
        const invoicePanel = document.getElementById('invoice-panel');
        const confirmSaleBtn = document.getElementById('confirm-sale');
        const resetInvoiceBtn = document.getElementById('reset-invoice');
        const amountReceivedInput = document.getElementById('amount-received');
        const calculateChangeBtn = document.getElementById('calculate-change');
        const changeAmountSpan = document.getElementById('change-amount');
        
        // MODIFICACIÓN: Elemento para WhatsApp (solo el botón, sin input)
        const sendWhatsAppBtn = document.getElementById('send-whatsapp');
        
        // Elementos modales
        const editProductModal = document.getElementById('edit-product-modal');
        const invoiceModal = document.getElementById('invoice-modal');
        const invoiceContent = document.getElementById('invoice-content');
        const printInvoiceBtn = document.getElementById('print-invoice');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const saveProductChangesBtn = document.getElementById('save-product-changes');
        
        // Elementos de cierre de caja
        const printReportBtn = document.getElementById('print-report');
        const closeCashierBtn = document.getElementById('close-cashier');
        const cashInputs = document.querySelectorAll('.cash-input');
        const resetBreakdownBtn = document.getElementById('reset-breakdown');
        const cashierNameInput = document.getElementById('cashier-name');
        const resetCashBreakdownBtn = document.getElementById('reset-cash-breakdown');
        
        // Elementos de entrada manual
        const manualCodeInput = document.getElementById('manual-code-input');
        const addManualCodeBtn = document.getElementById('add-manual-code');
        const increaseQuantityBtn = document.getElementById('increase-quantity');
        const decreaseQuantityBtn = document.getElementById('decrease-quantity');
        const manualQuantityDisplay = document.getElementById('manual-quantity');

        // NUEVO: Botón para imprimir PDF de desglose por categoría
        const printCategoryPdfBtn = document.getElementById('print-category-pdf');

        // =============================================================================
        // SECCIÓN 3: FUNCIONES DE INICIALIZACIÓN
        // =============================================================================
        
        /**
         * Inicializa la aplicación configurando event listeners y renderizando datos iniciales
         * @function init
         */
        function init() {
            renderCategoriesNav();
            renderCategories();
            updateInvoiceUI();
            loadCashBreakdown();
            
            // Event listeners para navegación y paneles
            warehouseBtn.addEventListener('click', toggleWarehousePanel);
            cashierBtn.addEventListener('click', toggleCashierPanel);
            closeWarehousePanelBtn.addEventListener('click', toggleWarehousePanel);
            closeCashierPanelBtn.addEventListener('click', toggleCashierPanel);
            
            // Event listeners para gestión de categorías
            addCategoryBtn.addEventListener('click', addNewCategory);
            
            // Event listeners para el escáner
            startScannerBtn.addEventListener('click', startScanner);
            stopScannerBtn.addEventListener('click', stopScanner);
            requestCameraBtn.addEventListener('click', requestCameraPermission);
            
            // Event listeners para factura y ventas
            confirmSaleBtn.addEventListener('click', confirmSale);
            resetInvoiceBtn.addEventListener('click', resetInvoice);
            calculateChangeBtn.addEventListener('click', calculateChange);
            
            // MODIFICACIÓN: Event listener para WhatsApp (solo cierre de caja)
            sendWhatsAppBtn.addEventListener('click', sendWhatsApp);
            
            // Event listeners para modales
            saveProductChangesBtn.addEventListener('click', saveProductChanges);
            printInvoiceBtn.addEventListener('click', printInvoice);
            
            // Event listeners para cierre de caja
            printReportBtn.addEventListener('click', validateCashierBeforePrint);
            closeCashierBtn.addEventListener('click', toggleCashierPanel);
            resetBreakdownBtn.addEventListener('click', resetBreakdown);
            resetCashBreakdownBtn.addEventListener('click', resetCashBreakdown);
            
            // Event listeners para entrada manual
            addManualCodeBtn.addEventListener('click', processManualCode);
            increaseQuantityBtn.addEventListener('click', increaseManualQuantity);
            decreaseQuantityBtn.addEventListener('click', decreaseManualQuantity);
            
            // NUEVO: Event listener para imprimir PDF de desglose por categoría
            printCategoryPdfBtn.addEventListener('click', generateCategoryBreakdownPDF);
            
            // Permitir presionar Enter en el campo de código manual
            manualCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processManualCode();
                }
            });
            
            // Event listeners para inputs de efectivo
            cashInputs.forEach(input => {
                input.addEventListener('input', calculateCashTotals);
            });
            
            // Cerrar modales
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Cerrar modal haciendo clic fuera de él
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // Guardar datos al cerrar la página
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('categories', JSON.stringify(categories));
                saveCashBreakdown();
                if (stream) {
                    stopScanner();
                }
            });
        }

        // =============================================================================
        // SECCIÓN 4: FUNCIONES DE GESTIÓN DE ALMACÉN (INVENTARIO)
        // =============================================================================
        
        /**
         * Muestra/oculta el panel de gestión de inventario
         * @function toggleWarehousePanel
         */
        function toggleWarehousePanel() {
            warehousePanel.classList.toggle('open');
        }
        
        /**
         * Renderiza la navegación por categorías
         * @function renderCategoriesNav
         */
        function renderCategoriesNav() {
            categoriesNav.innerHTML = '';
            
            // Agregar botón para mostrar todos
            const allButton = document.createElement('button');
            allButton.className = 'category-btn active';
            allButton.textContent = 'Todos';
            allButton.addEventListener('click', () => filterProductsByCategory(null));
            categoriesNav.appendChild(allButton);
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category.name;
                button.addEventListener('click', () => filterProductsByCategory(category.id));
                categoriesNav.appendChild(button);
            });
        }
        
        /**
         * Filtra productos por categoría
         * @function filterProductsByCategory
         * @param {number} categoryId - ID de la categoría a filtrar (null para mostrar todas)
         */
        function filterProductsByCategory(categoryId) {
            // Cambiar clase activa en botones
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (categoryId === null) {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.textContent === 'Todos') btn.classList.add('active');
                });
                renderCategories();
            } else {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.textContent === categories.find(c => c.id === categoryId).name) btn.classList.add('active');
                });
                
                categoriesContainer.innerHTML = '';
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'category';
                    
                    categoryElement.innerHTML = `
                        <div class="category-header">
                            <h3>${category.name}</h3>
                            <button class="btn btn-danger" onclick="deleteCategory(${category.id})"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="category-tab" onclick="toggleAddProductForm(${category.id})">
                            <span>Agregar Producto</span>
                            <span><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="add-product-form" id="add-product-form-${category.id}">
                            <input type="text" id="product-name-${category.id}" placeholder="Nombre del producto">
                            <input type="number" id="product-price-${category.id}" placeholder="Precio" step="0.01">
                            <input type="number" id="product-quantity-${category.id}" placeholder="Cantidad">
                            <input type="text" id="product-code-${category.id}" placeholder="Código del producto">
                            <button class="btn" onclick="addProductToCategory(${category.id})" style="margin-top: 10px;"><i class="fas fa-plus"></i> Agregar Producto</button>
                        </div>
                        <div id="products-${category.id}">
                            ${renderProducts(category)}
                        </div>
                    `;
                    
                    categoriesContainer.appendChild(categoryElement);
                }
            }
        }
        
        /**
         * Muestra/oculta formulario para agregar producto
         * @function toggleAddProductForm
         * @param {number} categoryId - ID de la categoría
         */
        function toggleAddProductForm(categoryId) {
            const form = document.getElementById(`add-product-form-${categoryId}`);
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
        }
        
        /**
         * Renderiza todas las categorías y productos
         * @function renderCategories
         */
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            
            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category';
                
                categoryElement.innerHTML = `
                    <div class="category-header">
                        <h3>${category.name}</h3>
                        <button class="btn btn-danger" onclick="deleteCategory(${category.id})"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="category-tab" onclick="toggleAddProductForm(${category.id})">
                        <span>Agregar Producto</span>
                        <span><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="add-product-form" id="add-product-form-${category.id}">
                        <input type="text" id="product-name-${category.id}" placeholder="Nombre del producto">
                        <input type="number" id="product-price-${category.id}" placeholder="Precio" step="0.01">
                        <input type="number" id="product-quantity-${category.id}" placeholder="Cantidad">
                        <input type="text" id="product-code-${category.id}" placeholder="Código del producto">
                        <button class="btn" onclick="addProductToCategory(${category.id})" style="margin-top: 10px;"><i class="fas fa-plus"></i> Agregar Producto</button>
                    </div>
                    <div id="products-${category.id}">
                        ${renderProducts(category)}
                    </div>
                `;
                
                categoriesContainer.appendChild(categoryElement);
            });
            
            // Guardar en localStorage después de renderizar
            localStorage.setItem('categories', JSON.stringify(categories));
        }
        
        /**
         * Renderiza los productos de una categoría específica
         * @function renderProducts
         * @param {Object} category - Objeto de categoría
         * @returns {string} HTML con los productos renderizados
         */
        function renderProducts(category) {
            if (category.products.length === 0) {
                return '<p>No hay productos en esta categoría</p>';
            }
            
            return category.products.map(product => `
                <div class="product">
                    <div class="product-info">
                        <strong>${product.name}</strong> - $${product.price.toFixed(2)} 
                        <br> Cantidad: ${product.quantity}/${product.initialQuantity}
                        <br> Código: ${product.id}
                    </div>
                    <div class="product-actions">
                        <button class="btn" onclick="editProduct(${category.id}, '${product.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteProduct(${category.id}, '${product.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }
        
        /**
         * Agrega una nueva categoría
         * @function addNewCategory
         */
        function addNewCategory() {
            const name = newCategoryName.value.trim();
            if (!name) return;
            
            const newCategory = {
                id: Date.now(),
                name: name,
                products: []
            };
            
            categories.push(newCategory);
            newCategoryName.value = '';
            renderCategoriesNav();
            renderCategories();
        }
        
        /**
         * Elimina una categoría
         * @function deleteCategory
         * @param {number} categoryId - ID de la categoría a eliminar
         */
        function deleteCategory(categoryId) {
            if (confirm('¿Estás seguro de que quieres eliminar esta categoría y todos sus productos?')) {
                categories = categories.filter(cat => cat.id !== categoryId);
                renderCategoriesNav();
                renderCategories();
            }
        }
        
        /**
         * Agrega un producto a una categoría
         * @function addProductToCategory
         * @param {number} categoryId - ID de la categoría
         */
        function addProductToCategory(categoryId) {
            const category = categories.find(cat => cat.id === categoryId);
            if (!category) return;
            
            const name = document.getElementById(`product-name-${categoryId}`).value.trim();
            const price = parseFloat(document.getElementById(`product-price-${categoryId}`).value);
            const quantity = parseInt(document.getElementById(`product-quantity-${categoryId}`).value);
            const code = document.getElementById(`product-code-${categoryId}`).value.trim();
            
            if (!name || isNaN(price) || isNaN(quantity) || !code) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }
            
            // Verificar si el código ya existe
            const existingProduct = categories.flatMap(cat => cat.products).find(p => p.id === code);
            if (existingProduct) {
                alert('Ya existe un producto con este código.');
                return;
            }
            
            const newProduct = {
                id: code,
                name: name,
                price: price,
                quantity: quantity,
                initialQuantity: quantity
            };
            
            category.products.push(newProduct);
            
            // Limpiar campos
            document.getElementById(`product-name-${categoryId}`).value = '';
            document.getElementById(`product-price-${categoryId}`).value = '';
            document.getElementById(`product-quantity-${categoryId}`).value = '';
            document.getElementById(`product-code-${categoryId}`).value = '';
            
            renderCategories();
        }
        
        /**
         * Prepara la edición de un producto
         * @function editProduct
         * @param {number} categoryId - ID de la categoría
         * @param {string} productId - ID del producto
         */
        function editProduct(categoryId, productId) {
            const category = categories.find(cat => cat.id === categoryId);
            if (!category) return;
            
            const product = category.products.find(p => p.id === productId);
            if (!product) return;
            
            editingProduct = { categoryId, productId };
            
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-quantity').value = product.quantity;
            document.getElementById('edit-product-code').value = product.id;
            
            // Llenar selector de categorías
            const categorySelect = document.getElementById('edit-product-category');
            categorySelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                option.selected = (cat.id === categoryId);
                categorySelect.appendChild(option);
            });
            
            editProductModal.style.display = 'flex';
        }
        
        /**
         * Guarda los cambios de un producto editado
         * @function saveProductChanges
         */
        function saveProductChanges() {
            if (!editingProduct) return;
            
            const oldCategory = categories.find(cat => cat.id === editingProduct.categoryId);
            if (!oldCategory) return;
            
            const product = oldCategory.products.find(p => p.id === editingProduct.productId);
            if (!product) return;
            
            const newName = document.getElementById('edit-product-name').value;
            const newPrice = parseFloat(document.getElementById('edit-product-price').value);
            const newQuantity = parseInt(document.getElementById('edit-product-quantity').value);
            const newCategoryId = parseInt(document.getElementById('edit-product-category').value);
            const newCode = document.getElementById('edit-product-code').value.trim();
            
            if (!newName || isNaN(newPrice) || isNaN(newQuantity) || isNaN(newCategoryId) || !newCode) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }
            
            // Verificar si el nuevo código ya existe en otro producto
            if (newCode !== editingProduct.productId) {
                const existingProduct = categories.flatMap(cat => cat.products).find(p => p.id === newCode);
                if (existingProduct) {
                    alert('Ya existe un producto con este código.');
                    return;
                }
            }
            
            // Actualizar producto
            product.name = newName;
            product.price = newPrice;
            product.id = newCode;
            
            // Ajustar la cantidad inicial si la cantidad actual es mayor
            if (newQuantity > product.initialQuantity) {
                product.initialQuantity = newQuantity;
            }
            
            product.quantity = newQuantity;
            
            // Mover producto a otra categoría si es necesario
            if (newCategoryId !== editingProduct.categoryId) {
                const newCategory = categories.find(cat => cat.id === newCategoryId);
                if (newCategory) {
                    // Eliminar producto de la categoría anterior
                    oldCategory.products = oldCategory.products.filter(p => p.id !== product.id);
                    
                    // Agregar producto a la nueva categoría
                    newCategory.products.push(product);
                }
            }
            
            editProductModal.style.display = 'none';
            renderCategories();
        }
        
        /**
         * Elimina un producto
         * @function deleteProduct
         * @param {number} categoryId - ID de la categoría
         * @param {string} productId - ID del producto
         */
        function deleteProduct(categoryId, productId) {
            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                const category = categories.find(cat => cat.id === categoryId);
                if (!category) return;
                
                category.products = category.products.filter(p => p.id !== productId);
                renderCategories();
            }
        }

        // =============================================================================
        // SECCIÓN 5: FUNCIONES DE ESCÁNER AND FACTURACIÓN
        // =============================================================================
        
        /**
         * Solicita permiso para usar la cámara
         * @function requestCameraPermission
         */
        function requestCameraPermission() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    scannerVideo.srcObject = stream;
                    scannerOverlay.style.display = 'none';
                    startScannerBtn.style.display = 'none';
                    stopScannerBtn.style.display = 'inline-block';
                    
                    // Iniciar Quagga.js para escanear códigos de barras
                    initQuagga();
                })
                .catch(function(error) {
                    alert('No se pudo acceder a la cámara: ' + error.message);
                    // Mostrar opción de entrada manual
                    simulateManualScan();
                });
        }
        
        /**
         * Inicializa Quagga.js para escanear códigos de barras
         * @function initQuagga
         */
        function initQuagga() {
            if (quaggaInitialized) return;
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerVideo,
                    constraints: {
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error("Error al inicializar Quagga:", err);
                    alert("No se pudo inicializar el escáner. Usando modo manual.");
                    simulateManualScan();
                    return;
                }
                
                quaggaInitialized = true;
                Quagga.start();
                
                // Mostrar indicador de escaneo
                scanIndicator.style.display = 'block';
                
                // Detectar cuando se escanea un código
                Quagga.onDetected(function(result) {
                    const code = result.codeResult.code;
                    processScannedCode(code);
                });
            });
        }
        
        /**
         * Procesa un código escaneado
         * @function processScannedCode
         * @param {string} code - Código escaneado
         */
        function processScannedCode(code) {
            // Buscar el producto en todas las categorías
            for (const category of categories) {
                const product = category.products.find(p => p.id == code);
                if (product) {
                    addToInvoice(product, category.name);
                    
                    // Efecto visual de éxito
                    scanIndicator.style.backgroundColor = '#2ecc71';
                    setTimeout(() => {
                        scanIndicator.style.backgroundColor = '#3498db';
                    }, 500);
                    
                    return;
                }
            }
            
            // Código no encontrado
            scanIndicator.style.backgroundColor = '#e74c3c';
            setTimeout(() => {
                scanIndicator.style.backgroundColor = '#3498db';
            }, 500);
            
            alert('Producto no encontrado con código: ' + code);
        }
        
        /**
         * Procesa código ingresado manualmente
         * @function processManualCode
         */
        function processManualCode() {
            const code = manualCodeInput.value.trim();
            
            if (!code) {
                alert('Por favor ingresa un código válido');
                return;
            }
            
            // Buscar el producto en todas las categorías
            for (const category of categories) {
                const product = category.products.find(p => p.id == code);
                if (product) {
                    // Agregar la cantidad especificada manualmente
                    for (let i = 0; i < manualQuantity; i++) {
                        addToInvoice(product, category.name);
                    }
                    
                    manualCodeInput.value = '';
                    manualQuantity = 1;
                    manualQuantityDisplay.textContent = manualQuantity;
                    manualCodeInput.focus();
                    return;
                }
            }
            
            alert('Producto no encontrado con código: ' + code);
        }
        
        /**
         * Simula entrada manual de código (para dispositivos sin cámara)
         * @function simulateManualScan
         */
        function simulateManualScan() {
            scannerOverlay.innerHTML = `
                <p>Ingresa el código del producto:</p>
                <input type="text" id="manual-code-input" style="padding: 10px; width: 150px; font-size: 18px; text-align: center;">
                <div class="quantity-controls" style="justify-content: center;">
                    <button class="btn quantity-btn" onclick="decreaseManualQuantity()">-</button>
                    <span class="quantity-display" id="manual-quantity">1</span>
                    <button class="btn quantity-btn" onclick="increaseManualQuantity()">+</button>
                </div>
                <button class="btn" onclick="processManualCode()">Agregar Producto</button>
            `;
            scannerOverlay.style.display = 'flex';
            
            // Reasignar el event listener al nuevo botón
            document.getElementById('manual-code-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processManualCode();
                }
            });
        }
        
        /**
         * Inicia el escáner
         * @function startScanner
         */
        function startScanner() {
            if (!stream) {
                requestCameraPermission();
                return;
            }
            
            scannerOverlay.style.display = 'none';
            startScannerBtn.style.display = 'none';
            stopScannerBtn.style.display = 'inline-block';
            
            if (quaggaInitialized) {
                Quagga.start();
                scanIndicator.style.display = 'block';
            }
        }
        
        /**
         * Detiene el escáner
         * @function stopScanner
         */
        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (quaggaInitialized) {
                Quagga.stop();
                scanIndicator.style.display = 'none';
            }
            
            scannerVideo.srcObject = null;
            scannerOverlay.innerHTML = `
                <p>Haz clic en "Iniciar Escáner" para comenzar</p>
                <button id="request-camera" class="btn"><i class="fas fa-camera"></i> Permitir Cámara</button>
            `;
            scannerOverlay.style.display = 'flex';
            startScannerBtn.style.display = 'inline-block';
            stopScannerBtn.style.display = 'none';
            
            // Reasignar el event listener al nuevo botón
            document.getElementById('request-camera').addEventListener('click', requestCameraPermission);
        }
        
        /**
         * Aumenta la cantidad manual
         * @function increaseManualQuantity
         */
        function increaseManualQuantity() {
            manualQuantity++;
            manualQuantityDisplay.textContent = manualQuantity;
        }
        
        /**
         * Disminuye la cantidad manual
         * @function decreaseManualQuantity
         */
        function decreaseManualQuantity() {
            if (manualQuantity > 1) {
                manualQuantity--;
                manualQuantityDisplay.textContent = manualQuantity;
            }
        }
        
        /**
         * Agrega un producto a la factura
         * @function addToInvoice
         * @param {Object} product - Objeto de producto
         * @param {string} categoryName - Nombre de la categoría
         */
        function addToInvoice(product, categoryName) {
            // Verificar si hay suficiente stock
            if (product.quantity <= 0) {
                alert('No hay suficiente stock de este producto');
                return;
            }
            
            // Verificar si el producto ya está en la factura
            const existingItem = invoiceItems.find(item => item.product.id === product.id);
            
            if (existingItem) {
                // Verificar si hay suficiente stock para agregar más
                if (existingItem.quantity >= product.quantity) {
                    alert('No hay suficiente stock para agregar más unidades de este producto');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                invoiceItems.push({
                    product: product,
                    category: categoryName,
                    quantity: 1
                });
            }
            
            updateInvoiceUI();
            
            // MODIFICACIÓN: Mostrar la factura solo si hay productos
            if (invoiceItems.length > 0) {
                invoicePanel.classList.add('open');
            }
        }
        
        /**
         * Actualiza la interfaz de la factura
         * @function updateInvoiceUI
         */
        function updateInvoiceUI() {
            if (invoiceItems.length === 0) {
                invoiceItemsContainer.innerHTML = '<p class="empty-invoice">No hay productos en la factura</p>';
                invoicePanel.classList.remove('open');
            } else {
                invoiceItemsContainer.innerHTML = '';
                invoiceItems.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'invoice-item';
                    itemElement.innerHTML = `
                        <div>
                            <strong>${item.product.name}</strong> (${item.category})<br>
                            $${item.product.price.toFixed(2)} x ${item.quantity}
                        </div>
                        <div>
                            $${(item.product.price * item.quantity).toFixed(2)}
                            <button class="btn btn-danger" onclick="removeFromInvoice(${index})" style="margin-left: 10px;"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    invoiceItemsContainer.appendChild(itemElement);
                });
            }
            
            // Calcular total
            const total = invoiceItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            totalAmount.textContent = total.toFixed(2);
            
            // Limpiar campos de pago
            amountReceivedInput.value = '';
            changeAmountSpan.textContent = '0.00';
        }
        
        /**
         * Elimina un producto de la factura
         * @function removeFromInvoice
         * @param {number} index - Índice del producto a eliminar
         */
        function removeFromInvoice(index) {
            invoiceItems.splice(index, 1);
            updateInvoiceUI();
        }
        
        /**
         * Reinicia la factura
         * @function resetInvoice
         */
        function resetInvoice() {
            if (confirm('¿Estás seguro de que quieres reiniciar la factura? Se eliminarán todos los productos.')) {
                invoiceItems = [];
                updateInvoiceUI();
            }
        }
        
        /**
         * Confirma la venta y actualiza el inventario
         * @function confirmSale
         */
        function confirmSale() {
            // Validar que se haya ingresado un monto de pago válido
            const amountReceived = parseFloat(amountReceivedInput.value);
            const total = parseFloat(totalAmount.textContent);
            
            if (isNaN(amountReceived) || amountReceived < total) {
                alert('Por favor ingrese un monto válido mayor o igual al total de la factura.');
                return;
            }
            
            // Actualizar cantidades en el inventario
            invoiceItems.forEach(item => {
                const category = categories.find(cat => cat.name === item.category);
                if (category) {
                    const product = category.products.find(p => p.id === item.product.id);
                    if (product) {
                        product.quantity -= item.quantity;
                    }
                }
            });
            
            // Mostrar factura para impresión
            showInvoice();
            
            // Limpiar factura
            invoiceItems = [];
            updateInvoiceUI();
            
            // Actualizar vista de categorías
            renderCategories();
            
            alert('Venta registrada correctamente. El inventario ha sido actualizado.');
        }
        
        /**
         * Muestra la factura para impresión
         * @function showInvoice
         */
        function showInvoice() {
            invoiceContent.innerHTML = '';
            
            const invoice = document.createElement('div');
            invoice.innerHTML = `
                <div class="invoice-header">Tienda La Reina</div>
                <div>${new Date().toLocaleString()}</div>
            `;
            
            // Agrupar productos por categoría
            const productsByCategory = {};
            invoiceItems.forEach(item => {
                if (!productsByCategory[item.category]) {
                    productsByCategory[item.category] = [];
                }
                productsByCategory[item.category].push(item);
            });
            
            // Generar líneas de la factura por categoría
            Object.keys(productsByCategory).forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'invoice-section';
                categorySection.innerHTML = `<div class="invoice-line"><strong>Categoría: ${category}</strong></div>`;
                
                productsByCategory[category].forEach(item => {
                    categorySection.innerHTML += `
                        <div class="invoice-line">
                            <span>${item.product.name}</span>
                            <span>${item.quantity} x $${item.product.price}</span>
                        </div>
                        <div class="invoice-line">
                            <span></span>
                            <span>$${(item.product.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `;
                });
                
                invoice.appendChild(categorySection);
            });
            
            // Total
            const totalSection = document.createElement('div');
            totalSection.className = 'invoice-section';
            totalSection.innerHTML = `
                <div class 'invoice-line'>
                    <strong>Total:</strong>
                    <strong>$${totalAmount.textContent}</strong>
                </div>
            `;
            invoice.appendChild(totalSection);
            
            // Información de pago
            const amountReceived = parseFloat(amountReceivedInput.value);
            const change = amountReceived - parseFloat(totalAmount.textContent);
            
            const paymentSection = document.createElement('div');
            paymentSection.className = 'invoice-section';
            paymentSection.innerHTML = `
                <div class="invoice-line">
                    <span>Monto recibido:</span>
                    <span>$${amountReceived.toFixed(2)}</span>
                </div>
                <div class="invoice-line">
                    <span>Cambio:</span>
                    <span>$${change.toFixed(2)}</span>
                </div>
            `;
            invoice.appendChild(paymentSection);
            
            // Mensaje de agradecimiento
            const thanks = document.createElement('div');
            thanks.style.textAlign = 'center';
            thanks.style.marginTop = '15px';
            thanks.innerHTML = `
                <div>Gracias por su servicio</div>
                <div>Vuelva pronto</div>
            `;
            invoice.appendChild(thanks);
            
            invoiceContent.appendChild(invoice);
            invoiceModal.style.display = 'flex';
        }
        
        /**
         * Imprime la factura
         * @function printInvoice
         */
        function printInvoice() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Factura - Tienda La Reina</title>
                    <style>
                        body { font-family: 'Courier New', monospace; margin: 0; padding: 15px; }
                        .invoice { width: 100%; max-width: 300px; margin: 0 auto; }
                        .invoice-header { text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 18px; }
                        .invoice-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        .invoice-section { margin: 10px 0; border-top: 1px dashed #ccc; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    ${invoiceContent.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            invoiceModal.style.display = 'none';
        }
        
        /**
         * Calcula el cambio a devolver
         * @function calculateChange
         */
        function calculateChange() {
            const amountReceived = parseFloat(amountReceivedInput.value);
            const total = parseFloat(totalAmount.textContent);
            
            if (isNaN(amountReceived) || amountReceived < total) {
                alert('Por favor ingrese un monto válido mayor o igual al total de la factura.');
                return;
            }
            
            const change = amountReceived - total;
            changeAmountSpan.textContent = change.toFixed(2);
        }

        // =============================================================================
        // SECCIÓN 6: FUNCIONES DE CIERRE DE CAJA
        // =============================================================================
        
        /**
         * Muestra/oculta el panel de cierre de caja
         * @function toggleCashierPanel
         */
        function toggleCashierPanel() {
            cashierPanel.classList.toggle('open');
            if (cashierPanel.classList.contains('open')) {
                updateCashierPanel();
            }
        }
        
        /**
         * Actualiza el panel de cierre de caja
         * @function updateCashierPanel
         */
        function updateCashierPanel() {
            // Actualizar detalles de inventario por producto
            const inventoryDetails = document.getElementById('inventory-details-content');
            inventoryDetails.innerHTML = '';
            
            // Actualizar el desglose por categoría
            updateCategoryBreakdown();
            
            let grandTotalAmount = 0;
            
            categories.forEach(category => {
                let categoryTotalAmount = 0;
                let hasSoldProducts = false;
                
                // Crear contenedor para la categoría
                const categoryDetail = document.createElement('div');
                categoryDetail.className = 'category-detail';
                
                // Título de la categoría
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category.name;
                categoryDetail.appendChild(categoryTitle);
                
                // Encabezados de productos - MODIFICADO: Reemplazar "Precio" por "Producto inicial"
                const productHeaders = document.createElement('div');
                productHeaders.className = 'product-detail';
                productHeaders.innerHTML = `
                    <span class="product-name">Producto</span>
                    <span>inicial</span>
                    <span>Vendidos</span>
                    <span>Restante</span>
                    <span>Importe</span>
                `;
                categoryDetail.appendChild(productHeaders);
                
                category.products.forEach(product => {
                    const sold = product.initialQuantity - product.quantity;
                    const amount = sold * product.price;
                    
                    // Solo mostrar productos que se han vendido
                    if (sold > 0) {
                        hasSoldProducts = true;
                        
                        // Sumar a los totales de la categoría
                        categoryTotalAmount += amount;
                        
                        // Detalle del producto - MODIFICADO: Reemplazar precio por cantidad inicial
                        const productDetail = document.createElement('div');
                        productDetail.className = 'product-detail';
                        productDetail.innerHTML = `
                            <span class="product-name">${product.name}</span>
                            <span>${product.initialQuantity}</span>
                            <span>${sold}</span>
                            <span>${product.quantity}</span>
                            <span>$${amount.toFixed(2)}</span>
                        `;
                        categoryDetail.appendChild(productDetail);
                    }
                });
                
                // Agregar total de categoría solo si hay productos vendidos
                if (hasSoldProducts) {
                    const categoryTotal = document.createElement('div');
                    categoryTotal.className = 'product-detail';
                    categoryTotal.style.fontWeight = 'bold';
                    categoryTotal.innerHTML = `
                        <span class="product-name">Total ${category.name}</span>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span>$${categoryTotalAmount.toFixed(2)}</span>
                    `;
                    categoryDetail.appendChild(categoryTotal);
                    
                    // Agregar categoría a los detalles
                    inventoryDetails.appendChild(categoryDetail);
                    
                    // Sumar a totales generales
                    grandTotalAmount += categoryTotalAmount;
                }
            });
            
            // Agregar total general
            const grandTotal = document.createElement('div');
            grandTotal.className = 'category-detail';
            grandTotal.style.marginTop = '20px';
            grandTotal.style.paddingTop = '10px';
            grandTotal.style.borderTop = '2px solid #333';
            
            const grandTotalTitle = document.createElement('div');
            grandTotalTitle.className = 'category-title';
            grandTotalTitle.textContent = 'TOTAL GENERAL';
            grandTotal.appendChild(grandTotalTitle);
            
            const grandTotalRow = document.createElement('div');
            grandTotalRow.className = 'product-detail';
            grandTotalRow.style.fontWeight = 'bold';
            grandTotalRow.style.fontSize = '16px';
            grandTotalRow.innerHTML = `
                <span class="product-name"></span>
                <span></span>
                <span></span>
                <span></span>
                <span>$${grandTotalAmount.toFixed(2)}</span>
            `;
            grandTotal.appendChild(grandTotalRow);
            
            inventoryDetails.appendChild(grandTotal);
            
            document.getElementById('total-sales').textContent = grandTotalAmount.toFixed(2);
            
            // Calcular total de efectivo
            calculateCashTotals();
        }
        
        /**
         * Actualiza el desglose por categoría
         * @function updateCategoryBreakdown
         */
        function updateCategoryBreakdown() {
            const breakdownContainer = document.getElementById('category-breakdown');
            breakdownContainer.innerHTML = '';
            
            let grandTotal = 0;
            
            categories.forEach((category, index) => {
                // Verificar si la categoría tiene productos
                if (category.products.length === 0) return;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-breakdown';
                
                // Título de la categoría con color
                const title = document.createElement('div');
                title.className = `category-title category-color-${(index % 8) + 1}`;
                title.textContent = category.name;
                categoryDiv.appendChild(title);
                
                // Encabezados de columnas
                const headers = document.createElement('div');
                headers.className = 'product-breakdown header';
                headers.innerHTML = `
                    <span class="breakdown-name">Producto</span>
                    <span class="breakdown-column">Inicio</span>
                    <span class="breakdown-column">Vend</span>
                    <span class="breakdown-column">Impor</span>
                    <span class="breakdown-column">Rest</span>
                `;
                categoryDiv.appendChild(headers);
                
                let categoryTotal = 0;
                let categoryHasProducts = false;
                
                category.products.forEach(product => {
                    const sold = product.initialQuantity - product.quantity;
                    const amount = sold * product.price;
                    
                    // Solo mostrar productos con ventas o con existencia
                    if (sold > 0 || product.quantity > 0) {
                        categoryHasProducts = true;
                        categoryTotal += amount;
                        
                        const productDiv = document.createElement('div');
                        productDiv.className = 'product-breakdown';
                        productDiv.innerHTML = `
                            <span class="breakdown-name">${product.name}</span>
                            <span class="breakdown-column">${product.initialQuantity}</span>
                            <span class="breakdown-column">${sold}</span>
                            <span class="breakdown-column">$${amount.toFixed(2)}</span>
                            <span class="breakdown-column">${product.quantity}</span>
                        `;
                        categoryDiv.appendChild(productDiv);
                        
                        // Línea divisoria entre productos
                        const divider = document.createElement('div');
                        divider.className = 'divider';
                        categoryDiv.appendChild(divider);
                    }
                });
                
                // Solo agregar la categoría si tiene productos
                if (categoryHasProducts) {
                    // Total de la categoría
                    const totalDiv = document.createElement('div');
                    totalDiv.className = 'category-total';
                    totalDiv.innerHTML = `Total ${category.name}: $${categoryTotal.toFixed(2)}`;
                    categoryDiv.appendChild(totalDiv);
                    
                    // Agregar al total general
                    grandTotal += categoryTotal;
                    
                    breakdownContainer.appendChild(categoryDiv);
                }
            });
            
            // Total general
            const grandTotalDiv = document.createElement('div');
            grandTotalDiv.className = 'category-breakdown';
            grandTotalDiv.style.marginTop = '20px';
            grandTotalDiv.style.paddingTop = '10px';
            grandTotalDiv.style.borderTop = '2px solid #333';
            
            const grandTotalTitle = document.createElement('div');
            grandTotalTitle.className = 'category-title';
            grandTotalTitle.textContent = 'TOTAL GENERAL';
            grandTotalTitle.style.fontSize = '18px';
            grandTotalDiv.appendChild(grandTotalTitle);
            
            const grandTotalValue = document.createElement('div');
            grandTotalValue.className = 'category-total';
            grandTotalValue.style.fontSize = '18px';
            grandTotalValue.innerHTML = `$${grandTotal.toFixed(2)}`;
            grandTotalDiv.appendChild(grandTotalValue);
            
            breakdownContainer.appendChild(grandTotalDiv);
        }
        
        /**
         * Restablece el desglose
         * @function resetBreakdown
         */
        function resetBreakdown() {
            if (confirm('¿Estás seguro de que quieres restablecer el desglose? Esto reiniciará todas las cantidades iniciales a las cantidades actuales.')) {
                categories.forEach(category => {
                    category.products.forEach(product => {
                        // Establecer la cantidad inicial a la cantidad actual
                        product.initialQuantity = product.quantity;
                    });
                });
                
                // Guardar cambios
                localStorage.setItem('categories', JSON.stringify(categories));
                
                // Eliminar productos con cantidad cero y categorías vacías
                cleanupInventory();
                
                // Actualizar la vista
                updateCashierPanel();
                renderCategories();
                
                alert('Desglose restablecido correctamente.');
            }
        }
        
        /**
         * Limpia el inventario (elimina productos en cero y categorías vacías)
         * @function cleanupInventory
         */
        function cleanupInventory() {
            // Primero, eliminar productos con cantidad cero
            categories.forEach(category => {
                category.products = category.products.filter(product => product.quantity > 0);
            });
            
            // Luego, eliminar categorías vacías
            categories = categories.filter(category => category.products.length > 0);
            
            // Guardar cambios
            localStorage.setItem('categories', JSON.stringify(categories));
        }
        
        /**
         * Valida el nombre del cajero antes de imprimir
         * @function validateCashierBeforePrint
         */
        function validateCashierBeforePrint() {
            const cashierName = cashierNameInput.value.trim();
            if (!cashierName) {
                alert('Por favor ingrese el nombre de quien realiza el cierre de caja antes de imprimir el reporte.');
                cashierNameInput.focus();
                return;
            }
            printCashierReport();
        }
        
        /**
         * Imprime el reporte de cierre de caja
         * @function printCashierReport
         */
        function printCashierReport() {
            const cashierName = cashierNameInput.value.trim();
            const printWindow = window.open('', '_blank');
            
            // Crear tabla de desglose de efectivo con cantidad
            let cashBreakdownHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Denominación</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Cantidad</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Agregar filas para cada denominación
            const denominations = [
                { id: 'bill-1000', value: 1000, name: '$1000' },
                { id: 'bill-500', value: 500, name: '$500' },
                { id: 'bill-200', value: 200, name: '$200' },
                { id: 'bill-100', value: 100, name: '$100' },
                { id: 'bill-50', value: 50, name: '$50' },
                { id: 'bill-20', value: 20, name: '$20' },
                { id: 'coin-10', value: 10, name: 'Monedas $10' },
                { id: 'coin-5', value: 5, name: 'Monedas $5' },
                { id: 'coin-1', value: 1, name: 'Monedas $1' }
            ];
            
            denominations.forEach(denom => {
                const quantity = parseInt(document.getElementById(denom.id).value) || 0;
                const total = quantity * denom.value;
                cashBreakdownHTML += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${denom.name}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${quantity}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$${total.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            cashBreakdownHTML += '</tbody></table>';
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Reporte de Cierre de Caja - Tienda La Reina</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { text-align: center; color: #2c3e50; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .summary { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
                        .positive { color: #2ecc71; }
                        .negative { color: #e74c3c; }
                        .category-title { font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
                        .product-detail { display: flex; justify-content: space-between; }
                        .product-name { flex: 2; text-align: left; }
                        .product-detail span { flex: 1; text-align: center; }
                        .cashier-info { margin-bottom: 20px; text-align: right; }
                    </style>
                </head>
                <body>
                    <h1>Reporte de Cierre de Caja</h1>
                    <p>Fecha: ${new Date().toLocaleString()}</p>
                    <div class="cashier-info">
                        <strong>Cajero:</strong> ${cashierName}
                    </div>
                    
                    <h2>Productos Vendidos</h2>
                    ${document.getElementById('inventory-details-content').outerHTML}
                    
                    <h2>Desglose de Efectivo</h2>
                    ${cashBreakdownHTML}
                    
                    <div class="summary">
                        <h3>Resumen de Cierre</h3>
                        <p>Total en Efectivo: $${document.getElementById('total-cash').textContent}</p>
                        <p>Total de Ventas: $${document.getElementById('total-sales').textContent}</p>
                        <p>Diferencia: $${document.getElementById('cash-difference').textContent}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // =============================================================================
        // SECCIÓN 7: FUNCIONES DE GESTIÓN DE EFECTIVO
        // =============================================================================
        
        /**
         * Carga el desglose de efectivo desde localStorage
         * @function loadCashBreakdown
         */
        function loadCashBreakdown() {
            const savedBreakdown = JSON.parse(localStorage.getItem('cashBreakdown'));
            if (savedBreakdown) {
                cashBreakdown = savedBreakdown;
                
                // Actualizar los inputs con los valores guardados
                document.getElementById('bill-1000').value = cashBreakdown['bill-1000'];
                document.getElementById('bill-500').value = cashBreakdown['bill-500'];
                document.getElementById('bill-200').value = cashBreakdown['bill-200'];
                document.getElementById('bill-100').value = cashBreakdown['bill-100'];
                document.getElementById('bill-50').value = cashBreakdown['bill-50'];
                document.getElementById('bill-20').value = cashBreakdown['bill-20'];
                document.getElementById('coin-10').value = cashBreakdown['coin-10'];
                document.getElementById('coin-5').value = cashBreakdown['coin-5'];
                document.getElementById('coin-1').value = cashBreakdown['coin-1'];
                
                // Recalcular totales
                calculateCashTotals();
            }
        }
        
        /**
         * Guarda el desglose de efectivo en localStorage
         * @function saveCashBreakdown
         */
        function saveCashBreakdown() {
            // Actualizar objeto cashBreakdown con los valores actuales
            cashBreakdown['bill-1000'] = parseInt(document.getElementById('bill-1000').value) || 0;
            cashBreakdown['bill-500'] = parseInt(document.getElementById('bill-500').value) || 0;
            cashBreakdown['bill-200'] = parseInt(document.getElementById('bill-200').value) || 0;
            cashBreakdown['bill-100'] = parseInt(document.getElementById('bill-100').value) || 0;
            cashBreakdown['bill-50'] = parseInt(document.getElementById('bill-50').value) || 0;
            cashBreakdown['bill-20'] = parseInt(document.getElementById('bill-20').value) || 0;
            cashBreakdown['coin-10'] = parseInt(document.getElementById('coin-10').value) || 0;
            cashBreakdown['coin-5'] = parseInt(document.getElementById('coin-5').value) || 0;
            cashBreakdown['coin-1'] = parseInt(document.getElementById('coin-1').value) || 0;
            
            // Guardar en localStorage
            localStorage.setItem('cashBreakdown', JSON.stringify(cashBreakdown));
        }
        
        /**
         * Restablece solo el desglose de efectivo
         * @function resetCashBreakdown
         */
        function resetCashBreakdown() {
            if (confirm('¿Estás seguro de que quieres restablecer solo el desglose de efectivo? Todos los valores se pondrán en cero.')) {
                // Poner todos los inputs a cero
                document.getElementById('bill-1000').value = 0;
                document.getElementById('bill-500').value = 0;
                document.getElementById('bill-200').value = 0;
                document.getElementById('bill-100').value = 0;
                document.getElementById('bill-50').value = 0;
                document.getElementById('bill-20').value = 0;
                document.getElementById('coin-10').value = 0;
                document.getElementById('coin-5').value = 0;
                document.getElementById('coin-1').value = 0;
                
                // Actualizar el objeto y localStorage
                for (let key in cashBreakdown) {
                    cashBreakdown[key] = 0;
                }
                localStorage.setItem('cashBreakdown', JSON.stringify(cashBreakdown));
                
                // Recalcular totales
                calculateCashTotals();
                
                alert('Desglose de efectivo restablecido correctamente.');
            }
        }
        
        /**
         * Calcula los totales de efectivo
         * @function calculateCashTotals
         */
        function calculateCashTotals() {
            const denominations = [
                { id: 'bill-1000', value: 1000, totalId: 'total-1000' },
                { id: 'bill-500', value: 500, totalId: 'total-500' },
                { id: 'bill-200', value: 200, totalId: 'total-200' },
                { id: 'bill-100', value: 100, totalId: 'total-100' },
                { id: 'bill-50', value: 50, totalId: 'total-50' },
                { id: 'bill-20', value: 20, totalId: 'total-20' },
                { id: 'coin-10', value: 10, totalId: 'total-coin-10' },
                { id: 'coin-5', value: 5, totalId: 'total-coin-5' },
                { id: 'coin-1', value: 1, totalId: 'total-coin-1' }
            ];
            
            let totalCash = 0;
            
            denominations.forEach(denom => {
                const quantity = parseInt(document.getElementById(denom.id).value) || 0;
                const total = quantity * denom.value;
                document.getElementById(denom.totalId).textContent = `$${total.toFixed(2)}`;
                totalCash += total;
            });
            
            document.getElementById('total-cash').textContent = totalCash.toFixed(2);
            
            // Calcular diferencia
            const totalSales = parseFloat(document.getElementById('total-sales').textContent);
            const difference = totalCash - totalSales;
            document.getElementById('cash-difference').textContent = difference.toFixed(2);
            
            // Colorear diferencia
            const differenceElement = document.getElementById('cash-difference');
            if (difference < 0) {
                differenceElement.style.color = '#e74c3c';
            } else if (difference > 0) {
                differenceElement.style.color = '#2ecc71';
            } else {
                differenceElement.style.color = '#333';
            }
            
            // Guardar el desglose actualizado
            saveCashBreakdown();
        }
        
        // =============================================================================
        // SECCIÓN 8: FUNCIONES PARA WHATSAPP (MODIFICADAS)
        // =============================================================================
        
        /**
         * Envía el reporte de cierre de caja por WhatsApp
         * @function sendWhatsApp
         */
        function sendWhatsApp() {
            // Validar que el panel de cierre de caja esté abierto y tenga datos
            if (!cashierPanel.classList.contains('open')) {
                alert('Por favor, abra primero el panel de cierre de caja para enviar el reporte.');
                toggleCashierPanel();
                return;
            }
            
            // Validar que haya un nombre de cajero
            const cashierName = cashierNameInput.value.trim();
            if (!cashierName) {
                alert('Por favor ingrese el nombre de quien realiza el cierre de caja antes de enviar el reporte.');
                cashierNameInput.focus();
                return;
            }
            
            // Generar el PDF del reporte de cierre de caja
            generateCashierReportPDF();
        }
        
        /**
         * Genera el PDF del reporte de cierre de caja para WhatsApp
         * @function generateCashierReportPDF
         */
        function generateCashierReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración del documento
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let yPosition = margin;
            
            // Título
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Tienda La Reina", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 8;
            
            // Subtítulo
            doc.setFontSize(16);
            doc.text("Cierre de Caja", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Cajero, fecha y hora
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Cajero: ${cashierNameInput.value.trim()}`, margin, yPosition);
            yPosition += 6;
            doc.text(`Fecha y Hora: ${new Date().toLocaleString()}`, margin, yPosition);
            yPosition += 15;
            
            // Productos vendidos por categoría
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Productos Vendidos por Categoría", margin, yPosition);
            yPosition += 10;
            
            // Tabla de productos
            const tableColumn = ["Producto", "Inicial", "Vendido", "Restante", "Precio", "Importe"];
            const tableRows = [];
            
            let grandTotal = 0;
            
            categories.forEach(category => {
                let categoryTotal = 0;
                let hasProducts = false;
                
                category.products.forEach(product => {
                    const sold = product.initialQuantity - product.quantity;
                    if (sold > 0) {
                        hasProducts = true;
                        const amount = sold * product.price;
                        categoryTotal += amount;
                        
                        tableRows.push([
                            product.name,
                            product.initialQuantity.toString(),
                            sold.toString(),
                            product.quantity.toString(),
                            `$${product.price.toFixed(2)}`,
                            `$${amount.toFixed(2)}`
                        ]);
                    }
                });
                
                if (hasProducts) {
                    // Agregar subtotal de categoría
                    tableRows.push([
                        `TOTAL ${category.name}`,
                        "",
                        "",
                        "",
                        "",
                        `$${categoryTotal.toFixed(2)}`
                    ]);
                    
                    // Línea divisoria
                    tableRows.push(["", "", "", "", "", ""]);
                    
                    grandTotal += categoryTotal;
                }
            });
            
            // Agregar total general
            tableRows.push([
                "TOTAL GENERAL",
                "",
                "",
                "",
                "",
                `$${grandTotal.toFixed(2)}`
            ]);
            
            // Generar la tabla
            doc.autoTable({
                startY: yPosition,
                head: [tableColumn],
                body: tableRows,
                theme: 'grid',
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                },
                margin: { top: yPosition }
            });
            
            yPosition = doc.lastAutoTable.finalY + 15;
            
            // Desglose de efectivo
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Desglose de Efectivo", margin, yPosition);
            yPosition += 10;
            
            // Tabla de efectivo
            const cashTableColumn = ["Denominación", "Cantidad", "Total"];
            const cashTableRows = [];
            
            const denominations = [
                { id: 'bill-1000', value: 1000, name: '$1000' },
                { id: 'bill-500', value: 500, name: '$500' },
                { id: 'bill-200', value: 200, name: '$200' },
                { id: 'bill-100', value: 100, name: '$100' },
                { id: 'bill-50', value: 50, name: '$50' },
                { id: 'bill-20', value: 20, name: '$20' },
                { id: 'coin-10', value: 10, name: 'Monedas $10' },
                { id: 'coin-5', value: 5, name: 'Monedas $5' },
                { id: 'coin-1', value: 1, name: 'Monedas $1' }
            ];
            
            let cashTotal = 0;
            
            denominations.forEach(denom => {
                const quantity = parseInt(document.getElementById(denom.id).value) || 0;
                if (quantity > 0) {
                    const total = quantity * denom.value;
                    cashTotal += total;
                    cashTableRows.push([
                        denom.name,
                        quantity.toString(),
                        `$${total.toFixed(2)}`
                    ]);
                }
            });
            
            // Agregar total de efectivo
            cashTableRows.push([
                "TOTAL EFECTIVO",
                "",
                `$${cashTotal.toFixed(2)}`
            ]);
            
            // Generar la tabla de efectivo
            doc.autoTable({
                startY: yPosition,
                head: [cashTableColumn],
                body: cashTableRows,
                theme: 'grid',
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                }
            });
            
            yPosition = doc.lastAutoTable.finalY + 15;
            
            // Resumen de cierre
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Resumen de Cierre", margin, yPosition);
            yPosition += 10;
            
            const difference = cashTotal - grandTotal;
            let differenceText = `Diferencia: $${difference.toFixed(2)}`;
            
            if (difference < 0) {
                differenceText += " (FALTANTE)";
            } else if (difference > 0) {
                differenceText += " (SOBRANTE)";
            } else {
                differenceText += " (EXACTO)";
            }
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Total en Efectivo: $${cashTotal.toFixed(2)}`, margin, yPosition);
            yPosition += 7;
            doc.text(`Total de Ventas: $${grandTotal.toFixed(2)}`, margin, yPosition);
            yPosition += 7;
            doc.text(differenceText, margin, yPosition);
            
            // Guardar el PDF
            const pdfBlob = doc.output('blob');
            
            // Crear URL para el blob
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            // Crear el enlace de WhatsApp con el PDF
            const message = encodeURIComponent("Reporte de cierre de caja - Tienda La Reina");
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
            
            // Abrir WhatsApp en una nueva ventana
            const newWindow = window.open(whatsappUrl, '_blank');
            
            // Esperar un momento antes de intentar enviar el archivo
            setTimeout(() => {
                // Nota: En un entorno real, necesitarías un servidor para subir el archivo
                // y luego compartir el enlace, ya que WhatsApp Web no permite adjuntar
                // archivos directamente mediante URL
                alert("PDF generado correctamente. En un entorno real, aquí se enviaría el archivo PDF.");
                
                // Descargar el PDF para referencia
                doc.save('cierre_caja_tienda_la_reina.pdf');
            }, 1000);
        }

        // =============================================================================
        // SECCIÓN 9: NUEVA FUNCIÓN PARA GENERAR PDF DE DESGLOSE POR CATEGORÍA
        // =============================================================================
        
        /**
         * Genera un PDF con el desglose de productos por categoría
         * @function generateCategoryBreakdownPDF
         */
        function generateCategoryBreakdownPDF() {
            // Validar que haya un nombre de cajero
            const cashierName = cashierNameInput.value.trim();
            if (!cashierName) {
                alert('Por favor ingrese el nombre de quien realiza el cierre de caja antes de generar el PDF.');
                cashierNameInput.focus();
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración del documento
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let yPosition = margin;
            
            // Título
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Tienda La Reina", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 8;
            
            // Subtítulo
            doc.setFontSize(16);
            doc.text("Desglose de Productos por Categoría", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Cajero, fecha y hora
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Cajero: ${cashierName}`, margin, yPosition);
            yPosition += 6;
            doc.text(`Fecha y Hora: ${new Date().toLocaleString()}`, margin, yPosition);
            yPosition += 15;
            
            // Línea divisoria
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 15;
            
            // Desglose por categoría
            categories.forEach((category, index) => {
                // Verificar si la categoría tiene productos
                if (category.products.length === 0) return;
                
                // Título de categoría
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Categoría: ${category.name}`, margin, yPosition);
                yPosition += 10;
                
                // Encabezados de tabla
                const tableColumn = ["Producto", "Inicio", "Comprobado"];
                const tableRows = [];
                
                category.products.forEach(product => {
                    const sold = product.initialQuantity - product.quantity;
                    
                    // Solo mostrar productos con ventas o con existencia
                    if (sold > 0 || product.quantity > 0) {
                       tableRows.push([
                            product.name,
                            product.initialQuantity.toString(),
                            sold.toString(),
                            "" // Espacio para comprobado (se llenará a mano)
                        ]);
                    }
                });
                
                // Generar la tabla
                doc.autoTable({
                    startY: yPosition,
                    head: [tableColumn],
                    body: tableRows,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [52, 152, 219],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 247, 250]
                    },
                    margin: { top: yPosition }
                });
                
                yPosition = doc.lastAutoTable.finalY + 15;
                
                // Verificar si necesita nueva página
                if (yPosition > doc.internal.pageSize.getHeight() - 50) {
                    doc.addPage();
                    yPosition = margin;
                }
            });
            
            // Guardar el PDF
            doc.save(`desglose_categorias_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // =============================================================================
        // SECCIÓN 10: INICIALIZACIÓN Y FUNCIONES GLOBALES
        // =============================================================================
        
        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
        
        // Hacer funciones disponibles globalmente para los eventos onclick
        window.toggleWarehousePanel = toggleWarehousePanel;
        window.toggleCashierPanel = toggleCashierPanel;
        window.addNewCategory = addNewCategory;
        window.deleteCategory = deleteCategory;
        window.addProductToCategory = addProductToCategory;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.startScanner = startScanner;
        window.stopScanner = stopScanner;
        window.requestCameraPermission = requestCameraPermission;
        window.processManualCode = processManualCode;
        window.removeFromInvoice = removeFromInvoice;
        window.showInvoice = showInvoice;
        window.toggleAddProductForm = toggleAddProductForm;
        window.increaseManualQuantity = increaseManualQuantity;
        window.decreaseManualQuantity = decreaseManualQuantity;
        window.resetCashBreakdown = resetCashBreakdown;
        window.generateCategoryBreakdownPDF = generateCategoryBreakdownPDF;
    </script>
</body>
</html>
`