
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda La Reina - Sistema de Gestión</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        /* ESTILOS GENERALES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #f72585;
            --accent: #7209b7;
            --gray: #6c757d;
        }
        
        body {
            background-color: #f5f7fa;
            color: #2c3e50;
            padding: 20px;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: url("https://d.top4top.io/p_3525b1u9b0.jpg");
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        
        .main-content {
            margin-top: 5.3rem;
            position: relative;
            z-index: 1;
            display: none; /* Oculto inicialmente hasta que se establezca el tiempo */
        }
        
        /* HEADER */
        #header {
            height: 5.3rem;
            background-image: url("https://d.top4top.io/p_3525b1u9b0.jpg");
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            padding: 10px 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .IMG-P {
            display: flex;
            align-items: center;
            padding-left: 9px;
        }
        
        .FG-Studio1 {
            width: 80px;
            height: 80px;
            border-radius: 100px;
        }
        
        .Mensaje_Corrediso {
            font-size: 2rem;
            font-family: 'Cinzel', serif;
            color: #fff;
            text-shadow: 1px 6px 3px rgba(0, 0, 0, 0.4);
        }
        
        /* Botón de tiempo restante en el header */
        .timer-header-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin-right: 20px;
            cursor: pointer;
            font-weight: bold;
            display: none; /* Oculto inicialmente */
        }
        
        /* NAVEGACIÓN HORIZONTAL */
        .navegacion-categorias {
            position: fixed;
            top: 5rem;
            left: 0;
            width: 100%;
            background-color: #252525;
            padding: 10px 0;
            z-index: 99;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            display: none; /* Oculto inicialmente hasta que se establezca el tiempo */
        }
        
        .navegacion-categorias .btn {
            margin: 0;
        }
        
        /* CARD STYLES */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin-bottom: 20px;
            margin-top :12rem;
        }
        
        /* SCANNER STYLES */
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            overflow: hidden;
            border-radius: 15px;
            background: #000;
            aspect-ratio: 4/3;
        }
        
        #videoMain, #videoInventory, #videoCategory, #videoProduct {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 15px;
            object-fit: cover;
        }
        
        .scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 200px;
            border: 2px solid var(--success);
            border-radius: 15px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        
        .scan-line {
            position: absolute;
            width: 1%;
            height: 1px;
            background: var(--success);
            top: 0;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px var(--success);
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-success {
            background: var(--success);
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
        }
        
        .btn-danger {
            background: var(--warning);
            box-shadow: 0 4px 15px rgba(247, 37, 133, 0.3);
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* RESULT STYLES */
        .result-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .result-title {
            font-weight: 600;
            color: var(--success);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .result-content {
            word-break: break-all;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .format-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--accent);
            color: white;
            font-size: 0.8rem;
            margin-top: -5px;
        }
        
        /* FORM STYLES */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--success);
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.3);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* INVOICE STYLES */
        .invoice-panel {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            transform: translateY(100%);
            transition: transform 0.5s ease;
            max-height: 0;
            overflow: hidden;
            display: none;
        }
        
        .invoice-panel.open {
            transform: translateY(0);
            max-height: 1000px;
            display: block;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-total {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #3498db;
        }
        
        /* PAYMENT SECTION */
        .payment-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .payment-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .payment-result {
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        
        /* PANEL STYLES - MODIFICADOS PARA ANIMACIÓN DE DESLIZAMIENTO */
        .warehouse-panel, .cashier-panel {
            position: fixed;
            top: 0;
            width: 100%;
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            background-color :#f1f19;
            
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
        }
        
        .warehouse-panel {
            right: 0;
            transform: translateX(100%);
        }
        
        .warehouse-panel.open {
            transform: translateX(0);
        }
        
        .cashier-panel {
            left: 0;
            transform: translateX(-100%);
        }
        
        .cashier-panel.open {
            transform: translateX(0);
        }
        
        .close-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* CATEGORY STYLES */
        .category {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px; /* Separación entre categorías */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd; /* Borde para separar visualmente */
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .product {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-actions {
            display: flex;
            gap: 5px;
        }
        
        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* MANUAL INPUT */
        .manual-input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .manual-input-container input {
            flex: 1;
            min-width: 200px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .quantity-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }
        
        /* ESTILOS MEJORADOS PARA TABLAS */
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .breakdown-table thead tr {
            background-color: #4361ee;
            color: white;
            text-align: left;
            font-weight: bold;
        }
        
        .breakdown-table th,
        .breakdown-table td {
            padding: 12px 15px;
        }
        
        .breakdown-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }
        
        .breakdown-table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
        
        .breakdown-table tbody tr:last-of-type {
            border-bottom: 2px solid #4361ee;
        }
        
        .breakdown-table tbody tr.active-row {
            font-weight: bold;
            color: #4361ee;
        }
        
        .category-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
            color: #2c3e50;
        }
        
        .category-total {
            font-weight: bold;
            background-color: #f9f9f9;
            text-align: right;
        }
        
        .category-total td:last-child {
            font-weight: bold;
        }
        
        /* CATEGORY NAVIGATION STYLES */
        .categories-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .category-btn {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        .category-btn:hover {
            background-color: #2980b9;
        }
        
        .category-btn.active {
            background-color: #2c3e50;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .warehouse-panel, .cashier-panel {
                width: 100%;
            }
            
            .navegacion-categorias {
                flex-direction: column;
                gap: 5px;
            }
            
            .manual-input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .manual-input-container input {
                min-width: auto;
            }
            
            .breakdown-table {
                font-size: 0.8rem;
            }
            
            .breakdown-table th,
            .breakdown-table td {
                padding: 5px;
            }
        }

        /* ESTILOS PARA EL SISTEMA DE NAVEGACIÓN */
        .navegacion-categorias {
            position: fixed;
            top: 5rem;
            left: 0;
            width: 100%;
            background-color:#252525;
            padding: 10px 0;
            z-index: 99;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
        }
        
        .navegacion-categorias a {
            color: #fff;
            text-decoration: none;
            padding: 8px 5px;
            margin: 0 5px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .navegacion-categorias a:hover,
        .navegacion-categorias a.activa {
            background-color: #c5a47e;
            color: #252525;
        }

        /* Estilos para el lector de inventario */
        .inventory-scanner {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para el formulario de agregar producto después de agregar categoría */
        .add-product-after-category {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px dashed #3498db;
        }
        
        /* Estilos para el desglose de categorías */
        .category-breakdown {
            margin-bottom: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .category-breakdown h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .product-breakdown {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .product-breakdown.header {
            font-weight: bold;
            background-color: #f2f2f2;
            border-radius: 4px;
            padding: 10px 0;
        }
        
        .breakdown-name {
            grid-column: 1;
        }
        
        .breakdown-column {
            text-align: center;
        }
        
        .category-total {
            font-weight: bold;
            margin-top: 10px;
            text-align: right;
            grid-column: 1 / -1;
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
        }
        
        /* BOTÓN ELIMINAR TODAS LAS CATEGORÍAS */
        .delete-all-categories {
            background-color: #e74c3c;
            color: white;
            margin-top: 10px;
        }
        
        .delete-all-categories:hover {
            background-color: #c0392b;
        }

        /* Estilos para las secciones de cámaras específicas */
        .camera-section {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .camera-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* NUEVOS ESTILOS PARA LA TABLA DE PRODUCTOS VENDIDOS - RESPONSIVE */
        .products-sold-container {
            width: 100%;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            background-color: white;
        }
        
        .products-sold-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            table-layout: fixed; /* Para que las columnas se ajusten uniformemente */
        }
        
        .products-sold-table thead tr {
            background-color: #4361ee;
            color: white;
            text-align: left;
            font-weight: bold;
        }
        
        .products-sold-table th,
        .products-sold-table td {
            padding: 12px 15px;
            text-align: center;
            word-wrap: break-word; /* Permite que el texto se ajuste dentro de las celdas */
        }
        
        .products-sold-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }
        
        .products-sold-table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
        
        .products-sold-table tbody tr:last-of-type {
            border-bottom: 2px solid #4361ee;
        }
        
        .category-total-row {
            background-color: #f0f0f0 !important;
            font-weight: bold;
        }
        
        .category-total-row td {
            text-align: right !important;
        }
        
        .grand-total-row {
            background-color: #d0d0d0 !important;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .grand-total-row td {
            text-align: right !important;
        }
        
        /* Estilo para el nombre de categoría arriba de la tabla - AJUSTE 1 */
        .category-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin: 15px 0 10px 0;
            padding: 10px;
            background-color: #4361ee;
            color: white;
            border-radius: 5px;
            text-align: center;
        }
        
        /* ESTILOS MEJORADOS PARA EL DESGLOSE DE EFECTIVO */
        .cashier-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            overflow: hidden;
        }

        .cashier-table thead tr {
            background-color: #4361ee;
            color: white;
            text-align: left;
            font-weight: bold;
        }

        .cashier-table th,
        .cashier-table td {
            padding: 12px 15px;
        }

        .cashier-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }

        .cashier-table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }

        .cashier-table tbody tr:last-of-type {
            border-bottom: 2px solid #4361ee;
        }

        .cashier-table tbody tr.active-row {
            font-weight: bold;
            color: #4361ee;
        }

        .cashier-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Estilo para pantallas pequeñas */
        @media (max-width: 768px) {
            .products-sold-table {
                font-size: 0.8rem;
            }
            
            .products-sold-table th,
            .products-sold-table td {
                padding: 8px 10px;
            }
            
            .category-name {
                font-size: 1rem;
                padding: 8px;
            }
            
            .cashier-table {
                font-size: 0.8rem;
            }
            
            .cashier-table th,
            .cashier-table td {
                padding: 8px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .products-sold-table {
                font-size: 0.7rem;
            }
            
            .products-sold-table th,
            .products-sold-table td {
                padding: 6px 8px;
            }
            
            .cashier-table {
                font-size: 0.7rem;
            }
            
            .cashier-table th,
            .cashier-table td {
                padding: 6px 8px;
            }
        }
        
        
        /*****CODIGO DE TEMPORISADOR ******/
        
        .timer-container {
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            margin: 100px auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .timer-container h1 {
            margin-bottom: 20px;
            font-size: 28px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            color: white;
        }

        .panel {
            display: none;
            margin-top: 20px;
        }

        .active {
            display: block;
        }

        .timer-container input, .timer-container select, .timer-container button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        .timer-container input, .timer-container select {
            background-color: rgba(255, 255, 255, 0.9);
        }

        .timer-container button {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .timer-container button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .timer-display {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            color: white;
        }

        .web-content {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff6b6b;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 9000;
            display: none;
        }

        .notification.warning {
            background-color: #ff9f43;
        }

        .notification.success {
            background-color: #1dd1a1;
        }

        .attempts-info {
            margin-top: 10px;
            font-size: 14px;
            color: #ff9f43;
        }

        .blocked-message {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        .reset-info {
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
            color: white;
        }
        
        /* Modal para mostrar tiempo restante */
        .time-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .time-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .time-modal h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .time-modal .timer-display {
            font-size: 48px;
            color: #4361ee;
            margin: 20px 0;
        }
        
        .time-modal button {
            background: #4361ee;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Estilos para el modal de contraseña del almacén */
        .warehouse-password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .warehouse-password-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .warehouse-password-content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .warehouse-password-content input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .warehouse-password-content button {
            background: #4361ee;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        .warehouse-password-content .btn-danger {
            background: #f72585;
        }
        
        /* Mensaje de error para contraseña del almacén */
        .warehouse-password-error {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }

        /* Estilos para la opción Premium */
        .premium-option {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
        }

        .premium-option:hover {
            background: linear-gradient(45deg, #FFA500, #FF8C00);
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    <!-- Temporizador - Visible inicialmente -->
    <div class="timer-container">
        <h1> Habilitar sistema de escaneo</h1>
        
        <!-- Panel de contraseña -->
        <div id="passwordPanel" class="panel active">
            <h2>Ingrese la Contraseña</h2>
            <input type="password" id="passwordInput" placeholder="Contraseña" required>
            <button id="submitPassword">Acceder</button>
            <div id="passwordError" class="hidden" style="color: #ff6b6b; margin-top: 10px;"></div>
            <div id="blockedMessage" class="blocked-message hidden"></div>
            <div class="reset-info">
                <p>Diseñador web Francisco  García <br> Todos los derechos están  reservados</p>
                <p id="attemptsInfo" class="attempts-info"></p>
            </div>
        </div>
        
        <!-- Panel de selección de tiempo -->
        <div id="timePanel" class="panel">
            <h2>Seleccione el Tiempo de Uso</h2>
            <select id="timeSelect">
                <option value="premium">Premium (Sin límite de tiempo)</option>
                <option value="1440">1 día (24 horas)</option>
                <option value="10080">1 semana</option>
                <option value="43200">1 mes (30 días)</option>
                <option value="129600">3 meses (90 días)</option>
                <option value="259200">6 meses (180 días)</option>
                <option value="518400">1 año (365 días)</option>
            </select>
            <button id="startTimer">Iniciar Temporizador</button>
        </div>
        
        <!-- Panel del temporizador activo -->
        <div id="timerPanel" class="panel">
            <h2>Tiempo Restante</h2>
            <div class="timer-display" id="timerDisplay">00:00</div>
            <button id="stopTimer">Detener Temporizador</button>
        </div>
    </div>
    
    <!-- Modal para mostrar tiempo restante -->
    <div class="time-modal" id="timeModal">
        <div class="time-modal-content">
            <h2 id="modalTitle">Tiempo Restante</h2>
            <div class="timer-display" id="modalTimerDisplay">00:00</div>
            <div id="premiumSection" style="display: none;">
                <p style="margin: 15px 0; font-size: 18px; font-weight: bold; color: #FFD700;">Opción Premium Activa</p>
                <input type="password" id="resetPremiumPassword" placeholder="Contraseña para desactivar Premium" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                <button id="resetPremiumBtn" style="width: 100%; padding: 10px; background: #f72585; color: white; border: none; border-radius: 5px; cursor: pointer;">Desactivar Premium</button>
            </div>
            <div id="timeSection" style="display: none;">
                <input type="password" id="resetTimePassword" placeholder="Contraseña para reiniciar" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                <button id="resetTimeBtn" style="width: 100%; padding: 10px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer;">Reiniciar Tiempo</button>
            </div>
            <button id="closeTimeModal" style="margin-top: 10px; width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cerrar</button>
        </div>
    </div>

    <!-- Modal para contraseña del almacén -->
    <div class="warehouse-password-modal" id="warehousePasswordModal">
        <div class="warehouse-password-content">
            <h2>Acceso al Almacén</h2>
            <input type="password" id="warehousePasswordInput" placeholder="Contraseña del almacén">
            <div id="warehousePasswordError" class="warehouse-password-error"></div>
            <div style="margin-top: 15px;">
                <button id="submitWarehousePassword" class="btn">Acceder</button>
                <button id="changeWarehousePassword" class="btn btn-warning">Cambiar Contraseña</button>
                <button id="resetWarehousePassword" class="btn btn-danger">Restablecer </button>
            </div>
            <button id="closeWarehousePasswordModal" class="btn" style="margin-top: 15px; background: #6c757d;">Cancelar</button>
        </div>
    </div>

    <!-- Notificaciones -->
    <div id="notification" class="notification"></div>

    <!-- Contenido de la tienda - Oculto inicialmente -->
    <div id="header">
        <div class="IMG-P">
            <a href="index.html">
                <img class="FG-Studio1" id="preview" src="https://i.ibb.co/LDG7Gf2d/fotor-ai-2025020222510.jpg" alt="Previsualización">
            </a>
            <marquee behavior="scroll" direction="left">
                <font class="Mensaje_Corrediso"> OPTIMICE SU TRABAJO CON FG-STUDIO CONTACTENOS AL +5353571569</font>
            </marquee>
        </div>
        <button id="show-time-btn" class="timer-header-btn">
            <i class="fas fa-clock"></i> Tiempo Restante
        </button>
    </div>

    <div class="main-content">
        
    <!-- SISTEMA DE NAVEGACIÓN -->
    <div class="navegacion-categorias">
        <button id="cashier-btn" class="btn btn-warning"><i class="fas fa-cash-register"></i> Cierre de Caja</button> 
        <button id="warehouse-btn" class="btn"><i class="fas fa-warehouse"></i> Almacen</button>
    </div>
        
        <!-- LECTOR PRINCIPAL -->
        <section class="card">
            <h2>Lector Principal (Ventas)</h2>
            <p>Escanea productos para registrar ventas</p>
            
            <div class="scanner-container">
                <video id="videoMain" playsinline></video>
                <div class="scan-area">
                    <div class="scan-line"></div>
                </div>
            </div>
            
            <div class="controls">
                <button id="startButtonMain" class="btn">
                    <i class="fas fa-camera"></i> <span>Iniciar Cámara</span>
                </button>
                <button id="stopButtonMain" class="btn btn-danger" style="display: none;">
                    <i class="fas fa-stop"></i> <span>Detener Cámara</span>
                </button>
            </div>
            
            <div class="result-container">
                <div class="result-title">Producto escaneado:</div>
                <div id="resultMain" class="result-content">Esperando escaneo...</div>
                <div id="formatMain" class="format-badge">-</div> 
            </div>
        </section>

        <!-- FACTURA DE VENTA -->
        <section class="invoice-panel" id="invoice-panel">
            <h2>Factura de Venta</h2>
            <div id="invoice-items">
                <p class="empty-invoice">No hay productos en la factura</p>
            </div>
            <div class="invoice-total">
                Total: $<span id="total-amount">0.00</span>
            </div>
            
            <!-- SECCIÓN DE PAGO -->
            <div class="payment-section">
                <h3>Pago</h3>
                <div class="payment-input">
                    <label for="amount-received">Monto recibido:</label>
                    <input type="number" id="amount-received" step="0.01" placeholder="0.00">
                    <button id="calculate-change" class="btn">Calcular Cambio</button>
                </div>
                <div id="change-result" class="payment-result">
                    Cambio a devolver: $<span id="change-amount">0.00</span>
                </div>
            </div>
            
            <button id="confirm-sale" class="btn btn-success" style="margin-top: 15px; width: 100%;">
                <i class="fas fa-check"></i> Confirmar Venta
            </button>
            <button id="reset-invoice" class="btn btn-danger" style="margin-top: 15px; width: 100%;">
                <i class="fas fa-sync"></i> Reiniciar Factura
            </button>
        </section>
    </div>

    <!-- PANEL DE ALMACÉN -->
    <div class="warehouse-panel" id="warehouse-panel">
        <button class="close-panel" id="close-warehouse-panel">&times;</button>
        <h2> CATEGORIAS </h2>
        
        <!-- NAVEGACIÓN HORIZONTAL DE CATEGORÍAS -->
        <div class="categories-nav" id="categories-nav">
            <!-- Las categorías se generarán dinámicamente -->
        </div>
        
        <!-- AGREGAR CATEGORÍA -->
        <div class="camera-section">
            <h3>Agregar Categoría</h3>
            <input type="text" id="new-category-name" placeholder="Nombre de categoría">
            <button id="add-category" class="btn" style="margin-top: 10px;">
                <i class="fas fa-plus"></i> Agregar Categoría
            </button>
            <button id="delete-all-categories" class="btn delete-all-categories" style="margin-top: 10px;">
                <i class="fas fa-trash"></i> Eliminar Todas las Categorías
            </button>
        </div>
        
        
        <!-- FORMULARIO PARA AGREGAR PRODUCTO DESPUÉS DE AGREGAR CATEGORÍA -->
        <div id="add-product-after-category" class="add-product-after-category" style="display: none;">
            <h3>Agregar Producto a la Nueva Categoría</h3>
            <p>Escanea el código del producto o ingrésalo manualmente:</p>
            <div class="inventory-scanner">
                <div class="scanner-container">
                    <video id="videoProduct" playsinline></video>
                    <div class="scan-area">
                        <div class="scan-line"></div>
                    </div>
                </div>
                <div class="controls">
                    <button id="startButtonProduct" class="btn">
                        <span>Iniciar Cámara de Producto</span>
                    </button>
                </div>
                <div class="manual-input-container">
                    <input type="text" id="inventory-code-input" placeholder="Código del producto">
                    <button id="add-product-from-scanner" class="btn">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                </div>
            </div>
            <div id="inventory-product-form" style="display: none;">
                <div class="form-group">
                    <label for="inventory-product-name">Nombre del producto:</label>
                    <input type="text" id="inventory-product-name" placeholder="Nombre del producto">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="inventory-product-price">Precio:</label>
                        <input type="number" id="inventory-product-price" placeholder="Precio" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="inventory-product-quantity">Cantidad en stock:</label>
                        <input type="number" id="inventory-product-quantity" placeholder="Cantidad">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="inventory-product-entry-date">Fecha de Entrada:</label>
                        <input type="date" id="inventory-product-entry-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="inventory-product-expiry-date">Fecha - Vence:</label>
                        <input type="date" id="inventory-product-expiry-date">
                    </div>
                </div>
                
                <button id="save-inventory-product" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar Producto
                </button>
            </div>
        </div>
        
        <br>
        
        <!-- CONTENEDOR DE CATEGORÍAS -->
        <div id="categories-container">
            <!-- Las categorías se mostrarán aquí -->
        </div>
    </div>

    <!-- PANEL DE CIERRE DE CAJA -->
    <div class="cashier-panel" id="cashier-panel">
        <button class="close-panel" id="close-cashier-panel">&times;</button>
        <h2>Cierre de Caja</h2>
        
        <!-- NOMBRE DEL CAJERO -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="cashier-name">Nombre de quien realiza el cierre:</label>
            <input type="text" id="cashier-name" placeholder="Ingrese su nombre">
        </div>
        
        <!-- PRODUCTOS VENDIDOS -->
        <div class="inventory-details">
            <h3>Productos Vendidos</h3>
            <div id="products-sold-content">
                <!-- Los productos vendidos se llenarán dinámicamente -->
            </div>
            
            <button id="reset-breakdown" class="btn btn-warning" style="margin-top: 20px;">
                <i class="fas fa-sync"></i> Restablecer Desglose
            </button>
            <button id="print-category-pdf" class="btn btn-pdf" style="margin-top: 15px;">
                <i class="fas fa-file-pdf"></i> Imprimir PDF de Desglose
            </button>
            
        </div>
        
        <br>  <br> <br>
        <!-- DESGLOSE DE EFECTIVO -->
        <h3>Desglose de Efectivo</h3>
        <br>
        <button id="reset-cash-breakdown" class="btn btn-cash-reset">
            <i class="fas fa-coins"></i> Restablecer Desglose de Efectivo
        </button>
        <br> <br>
        <table class="cashier-table" id="cash-breakdown">
            <thead>
                <tr>
                    <th>Denominación</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>$1000</td>
                    <td><input type="number" min="0" id="bill-1000" value="0" class="cash-input"></td>
                    <td id="total-1000">$0.00</td>
                </tr>
                <tr>
                    <td>$500</td>
                    <td><input type="number" min="0" id="bill-500" value="0" class="cash-input"></td>
                    <td id="total-500">$0.00</td>
                </tr>
                <tr>
                    <td>$200</td>
                    <td><input type="number" min="0" id="bill-200" value="0" class="cash-input"></td>
                    <td id="total-200">$0.00</td>
                </tr>
                <tr>
                    <td>$100</td>
                    <td><input type="number" min="0" id="bill-100" value="0" class="cash-input"></td>
                    <td id="total-100">$0.00</td>
                </tr>
                <tr>
                    <td>$50</td>
                    <td><input type="number" min="0" id="bill-50" value="0" class="cash-input"></td>
                    <td id="total-50">$0.00</td>
                </tr>
                <tr>
                    <td>$20</td>
                    <td><input type="number" min="0" id="bill-20" value="0" class="cash-input"></td>
                    <td id="total-20">$0.00</td>
                </tr>
                <tr>
                    <td>$10</td>
                    <td><input type="number" min="0" id="coin-10" value="0" class="cash-input"></td>
                    <td id="total-coin-10">$0.00</td>
                </tr>
                <tr>
                    <td>$5</td>
                    <td><input type="number" min="0" id="coin-5" value="0" class="cash-input"></td>
                    <td id="total-coin-5">$0.00</td>
                </tr>
                <tr>
                    <td>$1</td>
                    <td><input type="number" min="0" id="coin-1" value="0" class="cash-input"></td>
                    <td id="total-coin-1">$0.00</td>
                </tr>
            </tbody>
        </table>
        <br>
        <br>
        <!-- RESUMEN DE CIERRE -->
        <div class="cashier-summary">
            <h3>Resumen de Cierre</h3>
            <p>Total en Efectivo: $<span id="total-cash">0.00</span></p>
            <p>Total de Ventas: $<span id="total-sales">0.00</span></p>
            <p>Diferencia: $<span id="cash-difference">0.00</span></p>
        </div>
        <br>
        
        <!-- BOTÓN MODIFICADO: Eliminada la función de WhatsApp -->
        <button id="send-whatsapp" class="btn" style="margin-top: 15px;">
            <i class="fas fa-share-alt"></i> Compartir Cierre de Caja
        </button>
        <div class="whatsapp-info" style="margin-top: 10px; font-size: 0.9rem; color: #666;">
            Se descargará el reporte de cierre de caja en formato PDF.
        </div>
        
        <button id="close-cashier" class="btn btn-danger" style="margin-top: 20px;">
            <i class="fas fa-times"></i> Cerrar Caja
        </button>
    </div>

    <!-- MODAL PARA EDITAR PRODUCTO -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Producto</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit-product-name">Nombre:</label>
                <input type="text" id="edit-product-name">
            </div>
            <div class="form-group">
                <label for="edit-product-price">Precio:</label>
                <input type="number" id="edit-product-price" step="0.01">
            </div>
            <div class="form-group">
                <label for="edit-product-quantity">Cantidad:</label>
                <input type="number" id="edit-product-quantity">
            </div>
            <div class="form-group">
                <label for="edit-product-entry-date">Fecha de Entrada:</label>
                <input type="date" id="edit-product-entry-date">
            </div>
            <div class="form-group">
                <label for="edit-product-expiry-date">Fecha - Vencido:</label>
                <input type="date" id="edit-product-expiry-date">
            </div>
            <div class="form-group">
                <label for="edit-product-category">Categoría:</label>
                <select id="edit-product-category">
                    <!-- Las opciones se llenarán dinámicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="edit-product-code">Código:</label>
                <input type="text" id="edit-product-code">
            </div>
            <button id="save-product-changes" class="btn btn-success">Guardar Cambios</button>
        </div>
    </div>

    <!-- Elemento de audio para el sonido de escaneo -->
    <audio id="scanSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-electronic-retail-scanner-beep-1082.mp3" type="audio/mpeg">
    </audio>

    <script>
        // =============================================
        // SISTEMA DE ALMACENAMIENTO SEGURO
        // =============================================
        
        // Función mejorada para verificar y manejar el almacenamiento
        function isStorageAvailable() {
            try {
                const test = 'test';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.warn('localStorage no está disponible:', e);
                return false;
            }
        }

        // Función segura para guardar en localStorage
        function safeSetItem(key, value) {
            if (!isStorageAvailable()) {
                console.warn('No se puede guardar en localStorage. Usando almacenamiento en memoria.');
                return false;
            }
            
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Error al guardar en localStorage:', e);
                return false;
            }
        }

        // Función segura para leer de localStorage
        function safeGetItem(key, defaultValue = null) {
            if (!isStorageAvailable()) {
                console.warn('No se puede leer de localStorage. Usando valor por defecto.');
                return defaultValue;
            }
            
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error('Error al leer de localStorage:', e);
                return defaultValue;
            }
        }

        // Función segura para eliminar de localStorage
        function safeRemoveItem(key) {
            if (!isStorageAvailable()) {
                return false;
            }
            
            try {
                localStorage.removeItem(key);
                return true;
            } catch (e) {
                console.error('Error al eliminar de localStorage:', e);
                return false;
            }
        }

        // =============================================
        // SISTEMA DE TEMPORIZADOR - MODIFICADO CON ALMACENAMIENTO SEGURO Y OPCIÓN PREMIUM
        // =============================================
        
        // CONFIGURACIÓN - MODIFICAR AQUÍ PARA CAMBIAR LA CONTRASEÑA
        const correctPassword = "123"; // Contraseña del temporizador
        const maxAttempts = 3;
        const maxBlockTime = 24 * 60 * 60 * 1000; // 1 día en milisegundos
        const warningTime = 5 * 60 * 1000; // 5 minutos en milisegundos

        // Elementos del DOM
        const passwordPanel = document.getElementById('passwordPanel');
        const timePanel = document.getElementById('timePanel');
        const timerPanel = document.getElementById('timerPanel');
        const passwordInput = document.getElementById('passwordInput');
        const submitPassword = document.getElementById('submitPassword');
        const passwordError = document.getElementById('passwordError');
        const blockedMessage = document.getElementById('blockedMessage');
        const attemptsInfo = document.getElementById('attemptsInfo');
        const timeSelect = document.getElementById('timeSelect');
        const startTimer = document.getElementById('startTimer');
        const timerDisplay = document.getElementById('timerDisplay');
        const modalTimerDisplay = document.getElementById('modalTimerDisplay');
        const stopTimer = document.getElementById('stopTimer');
        const notification = document.getElementById('notification');
        const showTimeBtn = document.getElementById('show-time-btn');
        const timeModal = document.getElementById('timeModal');
        const closeTimeModal = document.getElementById('closeTimeModal');
        const resetTimeBtn = document.getElementById('resetTimeBtn');
        const resetTimePassword = document.getElementById('resetTimePassword');
        const resetPremiumBtn = document.getElementById('resetPremiumBtn');
        const resetPremiumPassword = document.getElementById('resetPremiumPassword');
        const modalTitle = document.getElementById('modalTitle');
        const premiumSection = document.getElementById('premiumSection');
        const timeSection = document.getElementById('timeSection');

        // Variables de estado
        let remainingTime = 0;
        let timerInterval = null;
        let failedAttempts = 0;
        let lastAttemptTime = 0;
        let isBlocked = false;
        let premiumMode = false;

        // Cargar estado desde localStorage usando funciones seguras
        function loadState() {
            const savedTime = safeGetItem('remainingTime', 0);
            if (savedTime) {
                remainingTime = parseInt(savedTime);
                
                // Si hay tiempo restante, iniciar el temporizador automáticamente
                if (remainingTime > 0) {
                    startTimerFromStorage();
                }
            }
            
            // Cargar intentos fallidos
            const savedAttempts = safeGetItem('failedAttempts', 0);
            if (savedAttempts) {
                failedAttempts = parseInt(savedAttempts);
            }
            
            // Cargar último intento
            const savedLastAttempt = safeGetItem('lastAttemptTime', 0);
            if (savedLastAttempt) {
                lastAttemptTime = parseInt(savedLastAttempt);
                
                // Verificar si el usuario está bloqueado
                checkBlockStatus();
            }
            
            // Cargar estado premium
            const savedPremium = safeGetItem('premiumMode', false);
            if (savedPremium) {
                premiumMode = true;
                activatePremiumMode();
            }
            
            updateAttemptsInfo();
        }

        // Activar modo premium
        function activatePremiumMode() {
            // Ocultar el temporizador y mostrar la tienda
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('.main-content').style.display = 'block';
            document.querySelector('.navegacion-categorias').style.display = 'flex';
            showTimeBtn.style.display = 'block';
            
            // Cambiar el texto del botón de tiempo
            showTimeBtn.innerHTML = '<i class="fas fa-crown"></i> Opción Premium';
            
            // Cambiar clase para estilo premium
            showTimeBtn.classList.add('premium-option');
            
            // Mostrar panel de temporizador
            showPanel(timerPanel);
            timerDisplay.textContent = 'Opción Premium';
        }

        // Verificar estado de bloqueo
        function checkBlockStatus() {
            if (failedAttempts >= maxAttempts) {
                const timeSinceLastAttempt = Date.now() - lastAttemptTime;
                
                if (timeSinceLastAttempt < maxBlockTime) {
                    isBlocked = true;
                    const remainingBlockTime = maxBlockTime - timeSinceLastAttempt;
                    updateBlockedMessage(remainingBlockTime);
                } else {
                    // Restablecer intentos si ha pasado el tiempo de bloqueo máximo
                    failedAttempts = 0;
                    safeSetItem('failedAttempts', failedAttempts);
                    isBlocked = false;
                    updateAttemptsInfo();
                }
            }
        }

        // Actualizar mensaje de bloqueo
        function updateBlockedMessage(remainingTime) {
            const hours = Math.floor(remainingTime / (60 * 60 * 1000));
            const minutes = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
            
            blockedMessage.textContent = `Demasiados intentos fallidos. Espere ${hours}h ${minutes}m para intentar nuevamente.`;
            blockedMessage.classList.remove('hidden');
            submitPassword.disabled = true;
            passwordInput.disabled = true;
        }

        // Actualizar información de intentos
        function updateAttemptsInfo() {
            if (failedAttempts > 0) {
                attemptsInfo.textContent = `Intentos fallidos: ${failedAttempts} de ${maxAttempts}`;
                attemptsInfo.classList.remove('hidden');
            } else {
                attemptsInfo.textContent = '';
                attemptsInfo.classList.add('hidden');
            }
        }

        // Iniciar temporizador desde almacenamiento
        function startTimerFromStorage() {
            showPanel(timerPanel);
            
            // Mostrar la tienda y ocultar el temporizador
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('.main-content').style.display = 'block';
            document.querySelector('.navegacion-categorias').style.display = 'flex';
            showTimeBtn.style.display = 'block';
            
            // Iniciar cuenta regresiva
            timerInterval = setInterval(updateTimer, 1000);
            updateTimerDisplay();
            
            // Verificar si mostrar advertencia de tiempo por acabarse
            if (remainingTime <= warningTime) {
                showNotification(`El tiempo se está agotando. Quedan ${Math.ceil(remainingTime / 60000)} minutos.`, 'warning');
            }
        }

        // Mostrar panel específico
        function showPanel(panel) {
            passwordPanel.classList.remove('active');
            timePanel.classList.remove('active');
            timerPanel.classList.remove('active');
            panel.classList.add('active');
        }

        // Mostrar notificación
        function showNotification(message, type = '') {
            notification.textContent = message;
            notification.className = 'notification';
            if (type) {
                notification.classList.add(type);
            }
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Actualizar display del temporizador
        function updateTimerDisplay() {
            let displayText;
            
            // Calcular años, meses, días, horas, minutos y segundos
            const totalSeconds = Math.floor(remainingTime / 1000);
            const seconds = totalSeconds % 60;
            const totalMinutes = Math.floor(totalSeconds / 60);
            const minutes = totalMinutes % 60;
            const totalHours = Math.floor(totalMinutes / 60);
            const hours = totalHours % 24;
            const totalDays = Math.floor(totalHours / 24);
            const days = totalDays % 30;
            const totalMonths = Math.floor(totalDays / 30);
            const months = totalMonths % 12;
            const years = Math.floor(totalMonths / 12);
            
            // Formato: 1 año 9 meses 8 días 6 horas y el cronómetro de segundo restante
            if (years > 0 || months > 0 || days > 0 || hours > 0) {
                displayText = `${years > 0 ? `${years} año${years > 1 ? 's' : ''} ` : ''}${months > 0 ? `${months} mes${months > 1 ? 'es' : ''} ` : ''}${days > 0 ? `${days} día${days > 1 ? 's' : ''} ` : ''}${hours > 0 ? `${hours} hora${hours > 1 ? 's' : ''} ` : ''}${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                // Cuando solo quedan minutos y segundos
                displayText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            timerDisplay.textContent = displayText;
            modalTimerDisplay.textContent = displayText;
        }

        // Actualizar temporizador
        function updateTimer() {
            remainingTime -= 1000;
            safeSetItem('remainingTime', remainingTime);
            
            updateTimerDisplay();
            
            // Mostrar advertencia cuando queden 5 minutos o menos
            if (remainingTime === warningTime) {
                showNotification(`El tiempo se está agotando. Quedan ${Math.ceil(remainingTime / 60000)} minutos.`, 'warning');
            }
            
            // Cuando el tiempo se acabe
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                safeRemoveItem('remainingTime');
                
                // Ocultar la tienda y mostrar el temporizador
                document.querySelector('.timer-container').style.display = 'block';
                document.querySelector('.main-content').style.display = 'none';
                document.querySelector('.navegacion-categorias').style.display = 'none';
                showTimeBtn.style.display = 'none';
                
                showPanel(passwordPanel);
                showNotification('El tiempo de uso ha finalizado.', 'warning');
                
                // Resetear la página cuando llegue a 0 días y 0 horas
                resetPage();
            }
        }

        // Resetear página cuando el tiempo se acabe
        function resetPage() {
            // Limpiar todos los datos del localStorage
            safeRemoveItem('remainingTime');
            safeRemoveItem('failedAttempts');
            safeRemoveItem('lastAttemptTime');
            safeRemoveItem('premiumMode');
            safeRemoveItem('products');
            safeRemoveItem('sales');
            safeRemoveItem('categories');
            safeRemoveItem('initialStock');
            safeRemoveItem('cashBreakdown');
            safeRemoveItem('productsSold');
            
            // Recargar la página después de un breve retraso
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        // Detener temporizador manualmente
        function stopTimerManually() {
            clearInterval(timerInterval);
            remainingTime = 0;
            safeRemoveItem('remainingTime');
            
            // Ocultar la tienda y mostrar el temporizador
            document.querySelector('.timer-container').style.display = 'block';
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('.navegacion-categorias').style.display = 'none';
            showTimeBtn.style.display = 'none';
            
            showPanel(passwordPanel);
            showNotification('Temporizador detenido manualmente.', 'warning');
        }

        // Función para reiniciar el tiempo del temporizador
        function resetTimerInternal() {
            // Esta función está disponible solo internamente en el código
            // Se puede llamar desde la consola del desarrollador
            if (confirm('¿Está seguro de que desea reiniciar el temporizador? Esto establecerá el tiempo restante a 0.')) {
                clearInterval(timerInterval);
                remainingTime = 0;
                safeRemoveItem('remainingTime');
                
                // Ocultar la tienda y mostrar el temporizador
                document.querySelector('.timer-container').style.display = 'block';
                document.querySelector('.main-content').style.display = 'none';
                document.querySelector('.navegacion-categorias').style.display = 'none';
                showTimeBtn.style.display = 'none';
                
                showPanel(passwordPanel);
                showNotification('Temporizador reiniciado internamente.', 'success');
            }
        }

        // Función para reiniciar el tiempo con contraseña
        function resetTimerWithPassword() {
            const enteredPassword = resetTimePassword.value;
            
            if (enteredPassword === correctPassword) {
                // Reiniciar el temporizador
                clearInterval(timerInterval);
                remainingTime = 0;
                safeRemoveItem('remainingTime');
                
                // Ocultar el modal
                timeModal.style.display = 'none';
                
                // Mostrar el panel de contraseña para que el usuario pueda iniciar un nuevo temporizador
                showPanel(passwordPanel);
                
                // Limpiar el input
                resetTimePassword.value = '';
                
                // Mostrar notificación de éxito
                showNotification('Temporizador reiniciado. Puede establecer un nuevo tiempo.', 'success');
            } else {
                alert('Contraseña incorrecta');
                resetTimePassword.value = '';
            }
        }

        // Función para desactivar el modo premium
        function resetPremiumMode() {
            const enteredPassword = resetPremiumPassword.value;
            
            if (enteredPassword === correctPassword) {
                // Desactivar modo premium
                premiumMode = false;
                safeRemoveItem('premiumMode');
                
                // Ocultar el modal
                timeModal.style.display = 'none';
                
                // Mostrar el panel de contraseña para que el usuario pueda iniciar un nuevo temporizador
                showPanel(passwordPanel);
                
                // Limpiar el input
                resetPremiumPassword.value = '';
                
                // Recargar la página
                location.reload();
                
                // Mostrar notificación de éxito
                showNotification('Modo Premium desactivado.', 'success');
            } else {
                alert('Contraseña incorrecta');
                resetPremiumPassword.value = '';
            }
        }

        // Mostrar modal de tiempo restante
        function showTimeModal() {
            timeModal.style.display = 'flex';
            
            if (premiumMode) {
                // Modo premium activo
                modalTitle.textContent = 'Opción Premium';
                modalTimerDisplay.textContent = 'Premium Activo';
                premiumSection.style.display = 'block';
                timeSection.style.display = 'none';
            } else {
                // Modo temporizador normal
                modalTitle.textContent = 'Tiempo Restante';
                updateTimerDisplay();
                premiumSection.style.display = 'none';
                timeSection.style.display = 'block';
            }
        }

        // Event Listeners para el temporizador
        submitPassword.addEventListener('click', () => {
            if (isBlocked) {
                showNotification('Acceso bloqueado. Espere el tiempo especificado.', 'warning');
                return;
            }
            
            const enteredPassword = passwordInput.value.trim();
            
            if (enteredPassword === correctPassword) {
                // Contraseña correcta - resetear intentos fallidos
                failedAttempts = 0;
                safeSetItem('failedAttempts', failedAttempts);
                passwordError.classList.add('hidden');
                blockedMessage.classList.add('hidden');
                submitPassword.disabled = false;
                passwordInput.disabled = false;
                updateAttemptsInfo();
                
                // Mostrar panel de selección de tiempo
                showPanel(timePanel);
                passwordInput.value = '';
            } else {
                // Contraseña incorrecta
                failedAttempts++;
                safeSetItem('failedAttempts', failedAttempts);
                lastAttemptTime = Date.now();
                safeSetItem('lastAttemptTime', lastAttemptTime);
                
                passwordError.textContent = `Contraseña incorrecta. Intentos restantes: ${maxAttempts - failedAttempts}`;
                passwordError.classList.remove('hidden');
                updateAttemptsInfo();
                
                // Verificar si debe bloquearse
                if (failedAttempts >= maxAttempts) {
                    isBlocked = true;
                    updateBlockedMessage(maxBlockTime);
                    showNotification('Demasiados intentos fallidos. Acceso bloqueado por 24 horas.', 'warning');
                }
                
                passwordInput.value = '';
            }
        });

        startTimer.addEventListener('click', () => {
            const selectedValue = timeSelect.value;
            
            if (selectedValue === 'premium') {
                // Activar modo premium
                premiumMode = true;
                safeSetItem('premiumMode', true);
                activatePremiumMode();
                showNotification('Modo Premium activado correctamente.', 'success');
            } else {
                const selectedTime = parseInt(selectedValue) * 60 * 1000; // Convertir a milisegundos
                remainingTime = selectedTime;
                safeSetItem('remainingTime', remainingTime);
                
                // Iniciar temporizador
                showPanel(timerPanel);
                
                // Ocultar el temporizador y mostrar la tienda
                document.querySelector('.timer-container').style.display = 'none';
                document.querySelector('.main-content').style.display = 'block';
                document.querySelector('.navegacion-categorias').style.display = 'flex';
                showTimeBtn.style.display = 'block';
                
                timerInterval = setInterval(updateTimer, 1000);
                updateTimerDisplay();
                
                showNotification('Temporizador iniciado correctamente.', 'success');
            }
        });

        stopTimer.addEventListener('click', stopTimerManually);
        
        showTimeBtn.addEventListener('click', showTimeModal);
        
        closeTimeModal.addEventListener('click', () => {
            timeModal.style.display = 'none';
        });

        // Event listener para el botón de reinicio con contraseña
        resetTimeBtn.addEventListener('click', resetTimerWithPassword);

        // Event listener para el botón de desactivar premium
        resetPremiumBtn.addEventListener('click', resetPremiumMode);

        // Permitir enviar contraseña con Enter
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitPassword.click();
            }
        });

        // Permitir reiniciar con Enter en el modal de tiempo
        resetTimePassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                resetTimerWithPassword();
            }
        });

        // Permitir desactivar premium con Enter
        resetPremiumPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                resetPremiumMode();
            }
        });

        // =============================================
        // SISTEMA DE CONTRASEÑA PARA ALMACÉN - CORREGIDO
        // =============================================

        const warehousePasswordModal = document.getElementById('warehousePasswordModal');
        const warehousePasswordInput = document.getElementById('warehousePasswordInput');
        const submitWarehousePassword = document.getElementById('submitWarehousePassword');
        const changeWarehousePassword = document.getElementById('changeWarehousePassword');
        const resetWarehousePasswordBtn = document.getElementById('resetWarehousePassword');
        const closeWarehousePasswordModal = document.getElementById('closeWarehousePasswordModal');
        const warehouseBtn = document.getElementById('warehouse-btn');
        const warehousePanel = document.getElementById('warehouse-panel');
        const warehousePasswordError = document.getElementById('warehousePasswordError');

        // Configuración de contraseña del almacén - CORREGIDO
        const defaultWarehousePassword = "0000";
        let warehousePassword = safeGetItem('warehousePassword', defaultWarehousePassword);

        // Asegurarse de que la contraseña se guarde correctamente al inicio
        if (!safeGetItem('warehousePassword')) {
            safeSetItem('warehousePassword', defaultWarehousePassword);
        }

        // Función para abrir el almacén con contraseña
        function openWarehouseWithPassword() {
            warehousePasswordModal.style.display = 'flex';
            warehousePasswordInput.value = ''; // Limpiar campo al abrir
            warehousePasswordError.style.display = 'none'; // Ocultar errores
            warehousePasswordInput.focus(); // Enfocar el campo
        }

        // Función para verificar contraseña del almacén - CORREGIDA
        function verifyWarehousePassword() {
            const enteredPassword = warehousePasswordInput.value.trim();
            
            // Cargar la contraseña actual del almacenamiento
            warehousePassword = safeGetItem('warehousePassword', defaultWarehousePassword);
            
            if (enteredPassword === warehousePassword) {
                warehousePasswordModal.style.display = 'none';
                warehousePanel.classList.add('open');
                warehousePasswordInput.value = '';
                warehousePasswordError.style.display = 'none';
                showNotification('Acceso al almacén concedido.', 'success');
            } else {
                warehousePasswordError.textContent = 'Contraseña incorrecta. Intente nuevamente.';
                warehousePasswordError.style.display = 'block';
                warehousePasswordInput.value = '';
                warehousePasswordInput.focus();
            }
        }

        // Función para cambiar contraseña del almacén - CORREGIDA
        function changeWarehousePasswordFunc() {
            const currentPassword = prompt("Ingrese la contraseña actual:");
            
            // Cargar la contraseña actual del almacenamiento
            warehousePassword = safeGetItem('warehousePassword', defaultWarehousePassword);
            
            if (currentPassword === warehousePassword) {
                const newPassword = prompt("Ingrese la nueva contraseña:");
                if (newPassword && newPassword.trim() !== '') {
                    warehousePassword = newPassword;
                    safeSetItem('warehousePassword', newPassword);
                    showNotification('Contraseña cambiada correctamente.', 'success');
                    warehousePasswordModal.style.display = 'none';
                    warehousePasswordError.style.display = 'none';
                } else {
                    showNotification('La contraseña no puede estar vacía.', 'warning');
                }
            } else {
                showNotification('Contraseña actual incorrecta.', 'warning');
            }
        }

        // Función para restablecer contraseña del almacén
        function resetWarehousePasswordFunc() {
            const tempPassword = prompt("Contactar con su proveedor para su acceso ");
            
            // "Para restablecer la contraseña del almacén a '0000', ingrese la contraseña correcta <!-del temporizador:"
            
            
            
            
            
            if (tempPassword === correctPassword) {
                warehousePassword = defaultWarehousePassword;
                safeSetItem('warehousePassword', defaultWarehousePassword);
                alert('Contraseña del almacén restablecida a 0000.');
                warehousePasswordModal.style.display = 'none';
                warehousePasswordError.style.display = 'none';
            } else {
                alert('Contraseña incorrecta. No se puede restablecer.');
            }
        }

        // Event listeners corregidos para el sistema de contraseña del almacén
        warehouseBtn.addEventListener('click', openWarehouseWithPassword);
        submitWarehousePassword.addEventListener('click', verifyWarehousePassword);
        changeWarehousePassword.addEventListener('click', changeWarehousePasswordFunc);
        resetWarehousePasswordBtn.addEventListener('click', resetWarehousePasswordFunc);
        closeWarehousePasswordModal.addEventListener('click', () => {
            warehousePasswordModal.style.display = 'none';
            warehousePasswordInput.value = '';
            warehousePasswordError.style.display = 'none';
        });

        // Permitir enviar contraseña con Enter - CORREGIDO
        warehousePasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyWarehousePassword();
            }
        });

        // Función para restablecer contraseña del almacén (disponible en consola)
        function resetWarehousePasswordInternal() {
            if (confirm('¿Está seguro de que desea restablecer la contraseña del almacén? Esto eliminará la contraseña actual y la restablecerá a la contraseña por defecto.')) {
                safeRemoveItem('warehousePassword');
                warehousePassword = defaultWarehousePassword;
                showNotification('Contraseña restablecida correctamente. La nueva contraseña es: ' + defaultWarehousePassword, 'success');
            }
        }

        // Hacer función disponible globalmente
        window.resetWarehousePasswordInternal = resetWarehousePasswordInternal;

        // =============================================
        // INICIALIZACIÓN
        // =============================================
        
        // Inicializar
        loadState();
        
        // Si no hay tiempo restante, mostrar panel de contraseña
        if (remainingTime <= 0 && !premiumMode) {
            showPanel(passwordPanel);
            checkBlockStatus();
        }

        // =============================================
        // HACER FUNCIONES INTERNAS DISPONIBLES GLOBALMENTE
        // =============================================
        window.resetTimerInternal = resetTimerInternal;
        window.resetWarehousePasswordInternal = resetWarehousePasswordInternal;

        // =============================================
        // 1. VARIABLES GLOBALES Y CONSTANTES
        // =============================================
        const APP_CONFIG = {
            STORAGE_KEYS: {
                PRODUCTS: 'products',
                SALES: 'sales',
                CATEGORIES: 'categories',
                INITIAL_STOCK: 'initialStock',
                CASH_BREAKDOWN: 'cashBreakdown',
                PRODUCTS_SOLD: 'productsSold'
            },
            DEFAULT_CATEGORIES: ['Bebidas', 'Alimentos', 'Limpieza', 'Hogar'],
            WHATSAPP_NUMBER: '+5353571569'
        };

        // Estado de la aplicación
        let appState = {
            videoStreamMain: null,
            videoStreamInventory: null,
            videoStreamCategory: null,
            videoStreamProduct: null,
            scanningIntervalMain: null,
            scanningIntervalInventory: null,
            scanningIntervalCategory: null,
            scanningIntervalProduct: null,
            products: [],
            sales: [],
            categories: [],
            currentCategory: 'all',
            invoiceItems: [],
            currentScannedProduct: null,
            confirmationQuantity: 1,
            initialStock: {},
            cashBreakdown: {
                'bill-1000': 0,
                'bill-500': 0,
                'bill-200': 0,
                'bill-100': 0,
                'bill-50': 0,
                'bill-20': 0,
                'coin-10': 0,
                'coin-5': 0,
                'coin-1': 0
            },
            manualQuantity: 1,
            newCategoryAdded: null,
            recentlyScannedCodes: [],
            isScanning: false,
            productsSold: {}
        };

        // =============================================
        // 2. ELEMENTOS DOM
        // =============================================
        // Elementos principales
        const videoMain = document.getElementById('videoMain');
        const videoInventory = document.getElementById('videoInventory');
        const videoCategory = document.getElementById('videoCategory');
        const videoProduct = document.getElementById('videoProduct');
        const startButtonMain = document.getElementById('startButtonMain');
        const stopButtonMain = document.getElementById('stopButtonMain');
        const resultMain = document.getElementById('resultMain');
        const formatMain = document.getElementById('formatMain');
        
        // Elementos de la factura
        const invoicePanel = document.getElementById('invoice-panel');
        const invoiceItemsContainer = document.getElementById('invoice-items');
        const totalAmount = document.getElementById('total-amount');
        const amountReceivedInput = document.getElementById('amount-received');
        const calculateChangeBtn = document.getElementById('calculate-change');
        const changeAmountSpan = document.getElementById('change-amount');
        const confirmSaleBtn = document.getElementById('confirm-sale');
        const resetInvoiceBtn = document.getElementById('reset-invoice');
        
        // Elementos de navegación y paneles
        const cashierBtn = document.getElementById('cashier-btn');
        const cashierPanel = document.getElementById('cashier-panel');
        const closeWarehousePanelBtn = document.getElementById('close-warehouse-panel');
        const closeCashierPanelBtn = document.getElementById('close-cashier-panel');
        
        // Elementos de categorías
        const categoriesNav = document.getElementById('categories-nav');
        const categoriesContainer = document.getElementById('categories-container');
        const newCategoryName = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category');
        const deleteAllCategoriesBtn = document.getElementById('delete-all-categories');
        
        // Elementos de inventario
        const startButtonProduct = document.getElementById('startButtonProduct');
        const inventoryCodeInput = document.getElementById('inventory-code-input');
        const addProductFromScannerBtn = document.getElementById('add-product-from-scanner');
        const inventoryProductForm = document.getElementById('inventory-product-form');
        const inventoryProductName = document.getElementById('inventory-product-name');
        const inventoryProductPrice = document.getElementById('inventory-product-price');
        const inventoryProductQuantity = document.getElementById('inventory-product-quantity');
        const inventoryProductEntryDate = document.getElementById('inventory-product-entry-date');
        const inventoryProductExpiryDate = document.getElementById('inventory-product-expiry-date');
        const saveInventoryProductBtn = document.getElementById('save-inventory-product');
        const addProductAfterCategory = document.getElementById('add-product-after-category');
        
        // Elementos de cierre de caja
        const cashierNameInput = document.getElementById('cashier-name');
        const sendWhatsAppBtn = document.getElementById('send-whatsapp');
        const closeCashierBtn = document.getElementById('close-cashier');
        const resetBreakdownBtn = document.getElementById('reset-breakdown');
        const resetCashBreakdownBtn = document.getElementById('reset-cash-breakdown');
        const printCategoryPdfBtn = document.getElementById('print-category-pdf');
        const cashInputs = document.querySelectorAll('.cash-input');
        const productsSoldContent = document.getElementById('products-sold-content');
        
        // Elementos modales
        const editProductModal = document.getElementById('edit-product-modal');
        const saveProductChangesBtn = document.getElementById('save-product-changes');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        
        // =============================================
        // 3. INICIALIZACIÓN DE LA APLICACIÓN
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // Cargar datos del localStorage usando funciones seguras
            loadDataFromStorage();
            
            // Establecer fecha actual como valor por defecto para fecha de entrada
            const today = new Date().toISOString().split('T')[0];
            if (inventoryProductEntryDate) {
                inventoryProductEntryDate.value = today;
            }
            
            // Renderizar elementos iniciales
            renderCategoriesNav();
            renderCategories();
            updateCashBreakdownUI();
            updateProductsSoldUI();
        }

        function setupEventListeners() {
            // Eventos del lector principal
            startButtonMain.addEventListener('click', startCameraMain);
            stopButtonMain.addEventListener('click', stopCameraMain);
            
            // Eventos de la factura
            confirmSaleBtn.addEventListener('click', confirmSale);
            resetInvoiceBtn.addEventListener('click', resetInvoice);
            calculateChangeBtn.addEventListener('click', calculateChange);
            
            // Eventos de navegación
            cashierBtn.addEventListener('click', toggleCashierPanel);
            closeWarehousePanelBtn.addEventListener('click', toggleWarehousePanel);
            closeCashierPanelBtn.addEventListener('click', toggleCashierPanel);
            
            // Eventos de categorías
            addCategoryBtn.addEventListener('click', addNewCategory);
            deleteAllCategoriesBtn.addEventListener('click', deleteAllCategories);
            
            // Eventos de inventario
            startButtonProduct.addEventListener('click', startCameraProduct);
            addProductFromScannerBtn.addEventListener('click', processInventoryCode);
            saveInventoryProductBtn.addEventListener('click', saveInventoryProduct);
            inventoryCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processInventoryCode();
                }
            });
            
            // Eventos de cierre de caja
            sendWhatsAppBtn.addEventListener('click', sendWhatsApp);
            closeCashierBtn.addEventListener('click', toggleCashierPanel);
            resetBreakdownBtn.addEventListener('click', resetBreakdown);
            resetCashBreakdownBtn.addEventListener('click', resetCashBreakdown);
            printCategoryPdfBtn.addEventListener('click', generateCategoryBreakdownPDF);
            
            // Eventos de inputs de efectivo
            cashInputs.forEach(input => {
                input.addEventListener('input', calculateCashTotals);
            });
            
            // Eventos modales
            saveProductChangesBtn.addEventListener('click', saveProductChanges);
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Cerrar modal haciendo clic fuera de él
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // Guardar datos al cerrar la página
            window.addEventListener('beforeunload', () => {
                saveDataToStorage();
                if (appState.videoStreamMain) {
                    stopCameraMain();
                }
                if (appState.videoStreamInventory) {
                    stopCameraInventory();
                }
                if (appState.videoStreamCategory) {
                    stopCameraCategory();
                }
                if (appState.videoStreamProduct) {
                    stopCameraProduct();
                }
            });
        }

        // =============================================
        // 4. FUNCIONES DE GESTIÓN DE DATOS - MODIFICADAS CON ALMACENAMIENTO SEGURO
        // =============================================
        function loadDataFromStorage() {
            appState.products = safeGetItem(APP_CONFIG.STORAGE_KEYS.PRODUCTS, []);
            appState.sales = safeGetItem(APP_CONFIG.STORAGE_KEYS.SALES, []);
            appState.categories = safeGetItem(APP_CONFIG.STORAGE_KEYS.CATEGORIES, APP_CONFIG.DEFAULT_CATEGORIES);
            appState.initialStock = safeGetItem(APP_CONFIG.STORAGE_KEYS.INITIAL_STOCK, {});
            appState.cashBreakdown = safeGetItem(APP_CONFIG.STORAGE_KEYS.CASH_BREAKDOWN, appState.cashBreakdown);
            appState.productsSold = safeGetItem(APP_CONFIG.STORAGE_KEYS.PRODUCTS_SOLD, {});
            
            // Si no hay stock inicial, establecerlo
            if (Object.keys(appState.initialStock).length === 0) {
                initializeInitialStock();
            }
            
            // Eliminar productos con cantidad 0
            removeZeroQuantityProducts();
        }

        function saveDataToStorage() {
            safeSetItem(APP_CONFIG.STORAGE_KEYS.PRODUCTS, appState.products);
            safeSetItem(APP_CONFIG.STORAGE_KEYS.SALES, appState.sales);
            safeSetItem(APP_CONFIG.STORAGE_KEYS.CATEGORIES, appState.categories);
            safeSetItem(APP_CONFIG.STORAGE_KEYS.INITIAL_STOCK, appState.initialStock);
            safeSetItem(APP_CONFIG.STORAGE_KEYS.CASH_BREAKDOWN, appState.cashBreakdown);
            safeSetItem(APP_CONFIG.STORAGE_KEYS.PRODUCTS_SOLD, appState.productsSold);
        }

        function initializeInitialStock() {
            appState.initialStock = {};
            appState.products.forEach(product => {
                appState.initialStock[product.code] = product.quantity || 0;
            });
            saveDataToStorage();
        }

        // =============================================
        // 5. FUNCIONES DEL LECTOR PRINCIPAL (VENTAS)
        // =============================================
        async function startCameraMain() {
            try {
                appState.videoStreamMain = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 130 },
                        height: { ideal: 340 }
                    },
                    audio: false
                });
                
                videoMain.srcObject = appState.videoStreamMain;
                videoMain.setAttribute('playsinline', true);
                await videoMain.play();
                
                startButtonMain.style.display = 'none';
                stopButtonMain.style.display = 'inline-flex';
                startScanningMain();
                
            } catch (error) {
                console.error('Error al acceder a la cámara principal:', error);
                resultMain.textContent = 'Error: No se pudo acceder a la cámara. Asegúrate de dar los permisos necesarios.';
            }
        }

        function stopCameraMain() {
            if (appState.scanningIntervalMain) {
                clearInterval(appState.scanningIntervalMain);
                appState.scanningIntervalMain = null;
            }
            
            if (appState.videoStreamMain) {
                appState.videoStreamMain.getTracks().forEach(track => track.stop());
                appState.videoStreamMain = null;
            }
            
            videoMain.srcObject = null;
            startButtonMain.style.display = 'inline-flex';
            stopButtonMain.style.display = 'none';
            appState.isScanning = false;
        }

        function startScanningMain() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            appState.isScanning = true;
            
            appState.scanningIntervalMain = setInterval(() => {
                if (!appState.isScanning) {
                    clearInterval(appState.scanningIntervalMain);
                    return;
                }
                
                if (videoMain.readyState === videoMain.HAVE_ENOUGH_DATA) {
                    canvas.width = videoMain.videoWidth;
                    canvas.height = videoMain.videoHeight;
                    
                    context.drawImage(videoMain, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Detectar código QR
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (qrCode) {
                        // Verificar si este código ya fue escaneado recientemente
                        if (!appState.recentlyScannedCodes.includes(qrCode.data)) {
                            processScannedCode(qrCode.data, 'Código QR');
                            appState.recentlyScannedCodes.push(qrCode.data);
                            
                            // Limpiar después de 2 segundos para permitir un nuevo escaneo
                            setTimeout(() => {
                                appState.recentlyScannedCodes = appState.recentlyScannedCodes.filter(code => code !== qrCode.data);
                            }, 2000);
                            
                            // Detener el escaneo después de detectar un código
                            appState.isScanning = false;
                            setTimeout(() => {
                                stopCameraMain();
                            }, 1000);
                        }
                    } else {
                        // Detectar código de barras
                        try {
                            Quagga.decodeSingle({
                                decoder: {
                                    readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'code_39_reader', 'upc_reader']
                                },
                                locate: true,
                                src: canvas.toDataURL()
                            }, function(result) {
                                if (result && result.codeResult) {
                                    // Verificar si este código ya fue escaneado recientemente
                                    if (!appState.recentlyScannedCodes.includes(result.codeResult.code)) {
                                        processScannedCode(result.codeResult.code, `Código de Barras (${result.codeResult.format})`);
                                        appState.recentlyScannedCodes.push(result.codeResult.code);
                                        
                                        // Limpiar después de 2 segundos para permitir un nuevo escaneo
                                        setTimeout(() => {
                                            appState.recentlyScannedCodes = appState.recentlyScannedCodes.filter(code => code !== result.codeResult.code);
                                        }, 2000);
                                        
                                        // Detener el escaneo después de detectar un código
                                        appState.isScanning = false;
                                        setTimeout(() => {
                                            stopCameraMain();
                                        }, 1000);
                                    }
                                }
                            });
                        } catch (error) {
                            // Continuar escaneo sin mostrar error
                        }
                    }
                }
            }, 500);
        }

        function processScannedCode(code, format) {
            // Reproducir sonido de escaneo
            scanSound.currentTime = 0;
            scanSound.play().catch(e => console.log("Error reproduciendo sonido:", e));
            
            resultMain.textContent = code;
            formatMain.textContent = format;
            
            // Buscar producto en el inventario
            const product = appState.products.find(item => item.code === code);
            
            if (product) {
                // Verificar si hay stock disponible
                if (product.quantity > 0) {
                    // Mostrar notificación mejorada
                    showScanNotification(`Producto escaneado: ${product.name}`);
                    
                    // Agregar a la factura con cantidad 1
                    addToInvoice(product, product.category || 'Sin categoría', 1);
                    
                } else {
                    showScanNotification(`Producto agotado: ${product.name}`, 'warning');
                }
            } else {
                showScanNotification('Producto no encontrado en el inventario', 'warning');
            }
            
            // Destacar brevemente el resultado
            resultMain.parentElement.style.borderLeftColor = '#4CAF50';
            setTimeout(() => {
                resultMain.parentElement.style.borderLeftColor = '#4361ee';
            }, 1000);
        }

        // =============================================
        // 6. FUNCIONES DE FACTURA
        // =============================================
        function addToInvoice(product, categoryName, quantity = 1) {
            // Verificar si hay suficiente stock
            if (product.quantity < quantity) {
                alert('No hay suficiente stock de este producto');
                return;
            }
            
            // Verificar si el producto ya está en la factura
            const existingItem = appState.invoiceItems.find(item => item.product.code === product.code);
            
            if (existingItem) {
                // Verificar si hay suficiente stock para agregar más
                if (existingItem.quantity + quantity > product.quantity) {
                    alert('No hay suficiente stock para agregar más unidades de este producto');
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                appState.invoiceItems.push({
                    product: product,
                    category: categoryName,
                    quantity: quantity
                });
            }
            
            updateInvoiceUI();
            
            // Mostrar la factura si hay productos
            if (appState.invoiceItems.length > 0) {
                invoicePanel.classList.add('open');
            }
        }

        function updateInvoiceUI() {
            if (appState.invoiceItems.length === 0) {
                invoiceItemsContainer.innerHTML = '<p class="empty-invoice">No hay productos en la factura</p>';
                invoicePanel.classList.remove('open');
            } else {
                invoiceItemsContainer.innerHTML = '';
                appState.invoiceItems.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'invoice-item';
                    itemElement.innerHTML = `
                        <div>
                            <strong>${item.product.name}</strong> (${item.category})<br>
                            $${item.product.price.toFixed(2)} x ${item.quantity}
                            <div class="quantity-controls" style="margin-top: 5px;">
                                <button class="btn quantity-btn" onclick="adjustInvoiceQuantity(${index}, -1)">-</button>
                                <span class="quantity-display">${item.quantity}</span>
                                <button class="btn quantity-btn" onclick="adjustInvoiceQuantity(${index}, 1)">+</button>
                            </div>
                        </div>
                        <div>
                            $${(item.product.price * item.quantity).toFixed(2)}
                            <button class="btn btn-danger" onclick="removeFromInvoice(${index})" style="margin-left: 10px; padding: 5px 10px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    invoiceItemsContainer.appendChild(itemElement);
                });
            }
            
            // Calcular total
            const total = appState.invoiceItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            totalAmount.textContent = total.toFixed(2);
            
            // Limpiar campos de pago
            amountReceivedInput.value = '';
            changeAmountSpan.textContent = '0.00';
        }

        function adjustInvoiceQuantity(index, adjustment) {
            const item = appState.invoiceItems[index];
            const newQuantity = item.quantity + adjustment;
            
            if (newQuantity < 1) {
                removeFromInvoice(index);
                return;
            }
            
            // Verificar si hay suficiente stock
            if (newQuantity > item.product.quantity) {
                alert('No hay suficiente stock para agregar más unidades de este producto');
                return;
            }
            
            item.quantity = newQuantity;
            updateInvoiceUI();
        }

        function removeFromInvoice(index) {
            appState.invoiceItems.splice(index, 1);
            updateInvoiceUI();
        }

        function resetInvoice() {
            if (confirm('¿Estás seguro de que quieres reiniciar la factura? Se eliminarán todos los productos.')) {
                appState.invoiceItems = [];
                updateInvoiceUI();
            }
        }

        function calculateChange() {
            const amountReceived = parseFloat(amountReceivedInput.value);
            const total = parseFloat(totalAmount.textContent);
            
            if (isNaN(amountReceived) || amountReceived < total) {
                alert('Por favor ingrese un monto válido mayor o igual al total de la factura.');
                return;
            }
            
            const change = amountReceived - total;
            changeAmountSpan.textContent = change.toFixed(2);
        }

        function confirmSale() {
            // Validar que se haya ingresado un monto de pago válido
            const amountReceived = parseFloat(amountReceivedInput.value);
            const total = parseFloat(totalAmount.textContent);
            
            if (isNaN(amountReceived) || amountReceived < total) {
                alert('Por favor ingrese un monto válido mayor o igual al total de la factura.');
                return;
            }
            
            // Actualizar cantidades en el inventario
            appState.invoiceItems.forEach(item => {
                const product = appState.products.find(p => p.code === item.product.code);
                if (product) {
                    // Calcular la cantidad vendida
                    const soldQuantity = item.quantity;
                    
                    // Actualizar la cantidad en el inventario
                    product.quantity -= soldQuantity;
                    if (product.quantity < 0) product.quantity = 0;
                    
                    // Registrar venta en productsSold
                    const category = product.category || 'Sin categoría';
                    if (!appState.productsSold[category]) {
                        appState.productsSold[category] = {};
                    }
                    
                    if (!appState.productsSold[category][product.code]) {
                        appState.productsSold[category][product.code] = {
                            name: product.name,
                            initialStock: appState.initialStock[product.code] || 0,
                            sold: 0,
                            price: product.price
                        };
                    }
                    
                    appState.productsSold[category][product.code].sold += soldQuantity;
                    
                    // Registrar venta en sales
                    for (let i = 0; i < soldQuantity; i++) {
                        appState.sales.push({
                            code: item.product.code,
                            name: item.product.name,
                            price: item.product.price,
                            category: item.category,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            });
            
            // Eliminar productos con cantidad 0
            removeZeroQuantityProducts();
            
            // Guardar cambios
            saveDataToStorage();
            
            // Mostrar factura para impresión
            showInvoice();
            
            // Limpiar factura
            appState.invoiceItems = [];
            updateInvoiceUI();
            
            // Actualizar vista de categorías
            renderCategories();
            
            // Actualizar la vista de productos vendidos
            updateProductsSoldUI();
            
            alert('Venta registrada correctamente. El inventario ha sido actualizado.');
        }

        function removeZeroQuantityProducts() {
            // Eliminar productos con cantidad 0
            appState.products = appState.products.filter(product => product.quantity > 0);
            
            // Eliminar categorías vacías
            const categoriesWithProducts = new Set(appState.products.map(p => p.category));
            appState.categories = appState.categories.filter(cat => categoriesWithProducts.has(cat));
            
            saveDataToStorage();
        }

        function showInvoice() {
            // En una implementación completa, aquí se mostraría la factura en un modal
            // Por simplicidad, solo mostramos un alert
            const total = parseFloat(totalAmount.textContent);
            const amountReceived = parseFloat(amountReceivedInput.value);
            const change = amountReceived - total;
            
            let invoiceText = "FACTURA - Tienda La Reina\n\n";
            invoiceText += "Productos:\n";
            
            appState.invoiceItems.forEach(item => {
                invoiceText += `${item.product.name} - $${item.product.price.toFixed(2)} x ${item.quantity} = $${(item.product.price * item.quantity).toFixed(2)}\n`;
            });
            
            invoiceText += `\nTotal: $${total.toFixed(2)}\n`;
            invoiceText += `Monto recibido: $${amountReceived.toFixed(2)}\n`;
            invoiceText += `Cambio: $${change.toFixed(2)}\n\n`;
            invoiceText += "¡Gracias por su compra!";
            
            alert(invoiceText);
        }

        // =============================================
        // 7. FUNCIONES DE GESTIÓN DE ALMACÉN
        // =============================================
        function toggleWarehousePanel() {
            warehousePanel.classList.toggle('open');
            if (warehousePanel.classList.contains('open')) {
                renderCategories();
            }
        }

        function renderCategoriesNav() {
            categoriesNav.innerHTML = '';
            
            // Agregar botón para mostrar todos
            const allButton = document.createElement('button');
            allButton.className = 'category-btn active';
            allButton.textContent = 'Todos';
            allButton.addEventListener('click', () => filterProductsByCategory(null));
            categoriesNav.appendChild(allButton);
            
            appState.categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category;
                button.addEventListener('click', () => filterProductsByCategory(category));
                categoriesNav.appendChild(button);
            });
        }

        function filterProductsByCategory(category) {
            // Cambiar clase activa en botones
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (category === null) {
                document.querySelectorAll('.category-btn')[0].classList.add('active');
                renderCategories();
            } else {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.textContent === category) btn.classList.add('active');
                });
                
                categoriesContainer.innerHTML = '';
                const filteredProducts = appState.products.filter(p => p.category === category);
                
                if (filteredProducts.length === 0) {
                    categoriesContainer.innerHTML = '<p>No hay productos en esta categoría</p>';
                    return;
                }
                
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category';
                
                categoryElement.innerHTML = `
                    <div class="category-header">
                        <h3>${category}</h3>
                        <button class="btn btn-danger" onclick="deleteCategory('${category}')">
                            <i class="fas fa-trash"></i> Eliminar Categoría
                        </button>
                    </div>
                    <div class="category-tab" onclick="toggleAddProductForm('${category}')">
                        <span>Agregar Producto con Lector</span>
                        <span><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="add-product-form" id="add-product-form-${category}" style="display: none;">
                        <div class="inventory-scanner">
                            <div class="scanner-container">
                                <video id="videoCategory-${category}" playsinline></video>
                                <div class="scan-area">
                                    <div class="scan-line"></div>
                                </div>
                            </div>
                            <div class="controls">
                                <button class="btn" onclick="startCategoryScanner('${category}')">
                                    <span>Iniciar Lector</span>
                                </button>
                            </div>
                            <div class="manual-input-container">
                                <input type="text" id="category-code-input-${category}" placeholder="Código del producto">
                                <button class="btn" onclick="addProductToCategoryFromCode('${category}')">
                                    <i class="fas fa-plus"></i> Agregar Producto
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="products-${category}">
                        ${renderProducts(filteredProducts)}
                    </div>
                `;
                
                categoriesContainer.appendChild(categoryElement);
            }
        }

        function renderCategories() {
            categoriesContainer.innerHTML = '';
            
            if (appState.products.length === 0) {
                categoriesContainer.innerHTML = '<p>No hay productos en el inventario</p>';
                return;
            }
            
            // Agrupar productos por categoría
            const productsByCategory = {};
            appState.products.forEach(product => {
                const category = product.category || 'Sin categoría';
                if (!productsByCategory[category]) {
                    productsByCategory[category] = [];
                }
                productsByCategory[category].push(product);
            });
            
            // Renderizar cada categoría
            Object.keys(productsByCategory).forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category';
                
                categoryElement.innerHTML = `
                    <div class="category-header">
                        <h3>${category}</h3>
                        <button class="btn btn-danger" onclick="deleteCategory('${category}')">
                            <i class="fas fa-trash"></i> Eliminar Categoría
                        </button>
                    </div>
                    <div class="category-tab" onclick="toggleAddProductForm('${category}')">
                        <span>Agregar Producto con Lector</span>
                        <span><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="add-product-form" id="add-product-form-${category}" style="display: none;">
                        <div class="inventory-scanner">
                            <div class="scanner-container">
                                <video id="videoCategory-${category}" playsinline></video>
                                <div class="scan-area">
                                    <div class="scan-line"></div>
                                </div>
                            </div>
                            <div class="controls">
                                <button class="btn" onclick="startCategoryScanner('${category}')">
                                    <span>Iniciar Lector</span>
                                </button>
                            </div>
                            <div class="manual-input-container">
                                <input type="text" id="category-code-input-${category}" placeholder="Código del producto">
                                <button class="btn" onclick="addProductToCategoryFromCode('${category}')">
                                    <i class="fas fa-plus"></i> Agregar Producto
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="products-${category}">
                        ${renderProducts(productsByCategory[category])}
                    </div>
                `;
                
                categoriesContainer.appendChild(categoryElement);
            });
        }

        function renderProducts(products) {
            if (products.length === 0) {
                return '<p>No hay productos en esta categoría</p>';
            }
            
            return products.map(product => `
                <div class="product">
                    <div class="product-info">
                        <strong>${product.name}</strong> - $${product.price.toFixed(2)} 
                        <br> Cantidad: ${product.quantity}
                        <br> Código: ${product.code}
                        ${product.entryDate ? `<br> Fecha Entrada: ${product.entryDate}` : ''}
                        ${product.expiryDate ? `<br> Fecha Vencimiento: ${product.expiryDate}` : ''}
                    </div>
                    <div class="product-actions">
                        <button class="btn" onclick="editProduct('${product.code}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct('${product.code}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function addNewCategory() {
            const name = newCategoryName.value.trim();
            if (!name) return;
            
            if (appState.categories.includes(name)) {
                alert('Esta categoría ya existe');
                return;
            }
            
            appState.categories.push(name);
            appState.newCategoryAdded = name;
            newCategoryName.value = '';
            renderCategoriesNav();
            renderCategories();
            saveDataToStorage();
            
            // Mostrar el formulario para agregar producto después de agregar categoría
            showAddProductAfterCategory();
        }

        function deleteAllCategories() {
            if (confirm('¿Estás seguro de que quieres eliminar TODAS las categorías? Esto también eliminará todos los productos.')) {
                appState.categories = [];
                appState.products = [];
                appState.initialStock = {};
                appState.productsSold = {};
                
                saveDataToStorage();
                renderCategoriesNav();
                renderCategories();
                
                alert('Todas las categorías y productos han sido eliminados.');
            }
        }

        function showAddProductAfterCategory() {
            addProductAfterCategory.style.display = 'block';
            inventoryCodeInput.value = '';
            inventoryProductForm.style.display = 'none';
            
            // Desplazar la vista al formulario
            addProductAfterCategory.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteCategory(categoryName) {
            if (confirm('¿Estás seguro de que quieres eliminar esta categoría? Todos los productos en esta categoría también serán eliminados.')) {
                // Eliminar productos de la categoría
                appState.products = appState.products.filter(product => product.category !== categoryName);
                
                // Eliminar la categoría
                appState.categories = appState.categories.filter(cat => cat !== categoryName);
                
                // Eliminar datos de productos vendidos de esta categoría
                if (appState.productsSold[categoryName]) {
                    delete appState.productsSold[categoryName];
                }
                
                // Guardar y actualizar
                saveDataToStorage();
                renderCategoriesNav();
                renderCategories();
                
                alert('Categoría y sus productos eliminados correctamente.');
            }
        }

        function toggleAddProductForm(category) {
            const form = document.getElementById(`add-product-form-${category}`);
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
        }

        function startCategoryScanner(category) {
            const videoElement = document.getElementById(`videoCategory-${category}`);
            
            navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 130 },
                    height: { ideal: 340 }
                },
                audio: false
            }).then(stream => {
                videoElement.srcObject = stream;
                videoElement.setAttribute('playsinline', true);
                videoElement.play();
                
                // Iniciar escaneo para esta categoría
                startCategoryScanning(videoElement, category);
            }).catch(error => {
                console.error('Error al acceder a la cámara:', error);
                alert('Error: No se pudo acceder a la cámara. Asegúrate de dar los permisos necesarios.');
            });
        }

        function startCategoryScanning(videoElement, category) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let scanningInterval = null;
            
            scanningInterval = setInterval(() => {
                if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    
                    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Detectar código QR
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (qrCode) {
                        // Rellenar el campo de código
                        document.getElementById(`category-code-input-${category}`).value = qrCode.data;
                        clearInterval(scanningInterval);
                        
                        // Detener la cámara
                        videoElement.srcObject.getTracks().forEach(track => track.stop());
                        videoElement.srcObject = null;
                        
                        // Procesar el código escaneado
                        addProductToCategoryFromCode(category);
                    } else {
                        // Detectar código de barras
                        try {
                            Quagga.decodeSingle({
                                decoder: {
                                    readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'code_39_reader', 'upc_reader']
                                },
                                locate: true,
                                src: canvas.toDataURL()
                            }, function(result) {
                                if (result && result.codeResult) {
                                    // Rellenar el campo de código
                                    document.getElementById(`category-code-input-${category}`).value = result.codeResult.code;
                                    clearInterval(scanningInterval);
                                    
                                    // Detener la cámara
                                    videoElement.srcObject.getTracks().forEach(track => track.stop());
                                    videoElement.srcObject = null;
                                    
                                    // Procesar el código escaneado
                                    addProductToCategoryFromCode(category);
                                }
                            });
                        } catch (error) {
                            // Continuar escaneo sin mostrar error
                        }
                    }
                }
            }, 500);
        }

        function addProductToCategoryFromCode(category) {
            const code = document.getElementById(`category-code-input-${category}`).value.trim();
            
            if (!code) {
                alert('Por favor ingresa un código válido');
                return;
            }
            
            // Verificar si el producto ya existe en cualquier categoría
            const existingProduct = appState.products.find(p => p.code === code);
            
            if (existingProduct) {
                alert('Este producto ya existe en la categoría: ' + existingProduct.category + '. No se pueden agregar productos duplicados.');
                return;
            } else {
                // Si no existe, mostrar formulario para agregarlo
                const form = document.getElementById(`add-product-form-${category}`);
                let productForm = document.getElementById(`product-form-${category}-${code}`);
                
                if (!productForm) {
                    productForm = document.createElement('div');
                    productForm.id = `product-form-${category}-${code}`;
                    const today = new Date().toISOString().split('T')[0];
                    productForm.innerHTML = `
                        <div class="form-group">
                            <label for="product-name-${category}-${code}">Nombre del producto:</label>
                            <input type="text" id="product-name-${category}-${code}" placeholder="Nombre del producto">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-price-${category}-${code}">Precio:</label>
                                <input type="number" id="product-price-${category}-${code}" placeholder="Precio" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="product-quantity-${category}-${code}">Cantidad en stock:</label>
                                <input type="number" id="product-quantity-${category}-${code}" placeholder="Cantidad">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-entry-date-${category}-${code}">Fecha de Entrada:</label>
                                <input type="date" id="product-entry-date-${category}-${code}" value="${today}">
                            </div>
                            <div class="form-group">
                                <label for="product-expiry-date-${category}-${code}">Fecha de Vencimiento:</label>
                                <input type="date" id="product-expiry-date-${category}-${code}">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="saveProductToCategory('${category}', '${code}')">
                            <i class="fas fa-save"></i> Guardar Producto
                        </button>
                    `;
                    
                    form.appendChild(productForm);
                }
            }
        }

        function saveProductToCategory(category, code) {
            const name = document.getElementById(`product-name-${category}-${code}`).value.trim();
            const price = parseFloat(document.getElementById(`product-price-${category}-${code}`).value);
            const quantity = parseInt(document.getElementById(`product-quantity-${category}-${code}`).value);
            const entryDate = document.getElementById(`product-entry-date-${category}-${code}`).value;
            const expiryDate = document.getElementById(`product-expiry-date-${category}-${code}`).value;
            
            if (!name || isNaN(price) || isNaN(quantity)) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }
            
            const newProduct = {
                code: code,
                name: name,
                price: price,
                quantity: quantity,
                category: category,
                entryDate: entryDate,
                expiryDate: expiryDate
            };
            
            appState.products.push(newProduct);
            
            // Guardar stock inicial si no existe
            if (!appState.initialStock[code]) {
                appState.initialStock[code] = quantity;
            }
            
            // Guardar y actualizar
            saveDataToStorage();
            renderCategories();
            
            alert('Producto agregado correctamente.');
            
            // Limpiar formulario
            document.getElementById(`product-form-${category}-${code}`).remove();
            document.getElementById(`category-code-input-${category}`).value = '';
        }

        // =============================================
        // 8. FUNCIONES DEL LECTOR DE PRODUCTOS (PARA NUEVAS CATEGORÍAS)
        // =============================================
        async function startCameraProduct() {
            try {
                appState.videoStreamProduct = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 130 },
                        height: { ideal: 340 }
                    },
                    audio: false
                });
                
                videoProduct.srcObject = appState.videoStreamProduct;
                videoProduct.setAttribute('playsinline', true);
                await videoProduct.play();
                
                startScanningProduct();
                
            } catch (error) {
                console.error('Error al acceder a la cámara de producto:', error);
                alert('Error: No se pudo acceder a la cámara. Asegúrate de dar los permisos necesarios.');
            }
        }

        function stopCameraProduct() {
            if (appState.scanningIntervalProduct) {
                clearInterval(appState.scanningIntervalProduct);
                appState.scanningIntervalProduct = null;
            }
            
            if (appState.videoStreamProduct) {
                appState.videoStreamProduct.getTracks().forEach(track => track.stop());
                appState.videoStreamProduct = null;
            }
            
            videoProduct.srcObject = null;
        }

        function startScanningProduct() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            appState.scanningIntervalProduct = setInterval(() => {
                if (videoProduct.readyState === videoProduct.HAVE_ENOUGH_DATA) {
                    canvas.width = videoProduct.videoWidth;
                    canvas.height = videoProduct.videoHeight;
                    
                    context.drawImage(videoProduct, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Detectar código QR
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (qrCode) {
                        processProductScannedCode(qrCode.data);
                    } else {
                        // Detectar código de barras
                        try {
                            Quagga.decodeSingle({
                                decoder: {
                                    readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'code_39_reader', 'upc_reader']
                                },
                                locate: true,
                                src: canvas.toDataURL()
                            }, function(result) {
                                if (result && result.codeResult) {
                                    processProductScannedCode(result.codeResult.code);
                                }
                            });
                        } catch (error) {
                            // Continuar escaneo sin mostrar error
                        }
                    }
                }
            }, 500);
        }

        function processProductScannedCode(code) {
            // Reproducir sonido de escaneo
            scanSound.currentTime = 0;
            scanSound.play().catch(e => console.log("Error reproduciendo sonido:", e));
            
            // Rellenar el campo de código
            inventoryCodeInput.value = code;
            
            // Verificar si el producto ya existe
            const existingProduct = appState.products.find(p => p.code === code);
            if (existingProduct) {
                alert('Este producto ya existe en la categoría: ' + existingProduct.category + '. No se pueden agregar productos duplicados.');
                stopCameraProduct();
                return;
            } else {
                // Si no existe, mostrar el formulario
                inventoryProductForm.style.display = 'block';
            }
            
            // Desplazar la vista al formulario
            inventoryProductForm.scrollIntoView({ behavior: 'smooth' });
            
            // Detener la cámara después del escaneo
            setTimeout(() => {
                stopCameraProduct();
            }, 1000);
        }

        function processInventoryCode() {
            const code = inventoryCodeInput.value.trim();
            
            if (!code) {
                alert('Por favor ingresa un código válido');
                return;
            }
            
            // Verificar si el producto ya existe
            const existingProduct = appState.products.find(p => p.code === code);
            if (existingProduct) {
                alert('Este producto ya existe en la categoría: ' + existingProduct.category + '. No se pueden agregar productos duplicados.');
                return;
            }
            
            inventoryProductForm.style.display = 'block';
            inventoryProductForm.scrollIntoView({ behavior: 'smooth' });
        }

        function saveInventoryProduct() {
            const code = inventoryCodeInput.value.trim();
            const name = inventoryProductName.value.trim();
            const price = parseFloat(inventoryProductPrice.value);
            const quantity = parseInt(inventoryProductQuantity.value);
            const entryDate = inventoryProductEntryDate.value;
            const expiryDate = inventoryProductExpiryDate.value;
            const category = appState.newCategoryAdded || 'Sin categoría';
            
            if (!code || !name || isNaN(price) || isNaN(quantity)) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }
            
            // Verificar si el producto ya existe
            const existingProductIndex = appState.products.findIndex(p => p.code === code);
            
            if (existingProductIndex !== -1) {
                alert('Este producto ya existe en la categoría: ' + appState.products[existingProductIndex].category + '. No se pueden agregar productos duplicados.');
                return;
            } else {
                // Crear nuevo producto
                const newProduct = {
                    code: code,
                    name: name,
                    price: price,
                    quantity: quantity,
                    category: category,
                    entryDate: entryDate,
                    expiryDate: expiryDate
                };
                
                appState.products.push(newProduct);
                
                // Guardar stock inicial
                if (!appState.initialStock[code]) {
                    appState.initialStock[code] = quantity;
                }
            }
            
            // Guardar y actualizar
            saveDataToStorage();
            renderCategories();
            
            // Limpiar campos y ocultar formulario
            inventoryCodeInput.value = '';
            inventoryProductName.value = '';
            inventoryProductPrice.value = '';
            inventoryProductQuantity.value = '';
            inventoryProductForm.style.display = 'none';
            addProductAfterCategory.style.display = 'none';
            appState.newCategoryAdded = null;
            
            alert('Producto guardado correctamente.');
        }

        function editProduct(code) {
            const product = appState.products.find(p => p.code === code);
            if (!product) return;
            
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-quantity').value = product.quantity;
            document.getElementById('edit-product-entry-date').value = product.entryDate || '';
            document.getElementById('edit-product-expiry-date').value = product.expiryDate || '';
            document.getElementById('edit-product-code').value = product.code;
            
            // Llenar selector de categorías
            const categorySelect = document.getElementById('edit-product-category');
            categorySelect.innerHTML = '';
            appState.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === product.category) option.selected = true;
                categorySelect.appendChild(option);
            });
            
            // Agregar opción "Sin categoría"
            const noCategoryOption = document.createElement('option');
            noCategoryOption.value = 'Sin categoría';
            noCategoryOption.textContent = 'Sin categoría';
            if (!product.category || product.category === 'Sin categoría') noCategoryOption.selected = true;
            categorySelect.appendChild(noCategoryOption);
            
            editProductModal.style.display = 'flex';
            
            // Guardar el código del producto que se está editando
            editProductModal.dataset.productCode = code;
        }

        function saveProductChanges() {
            const code = editProductModal.dataset.productCode;
            if (!code) return;
            
            const productIndex = appState.products.findIndex(p => p.code === code);
            if (productIndex === -1) return;
            
            const newName = document.getElementById('edit-product-name').value;
            const newPrice = parseFloat(document.getElementById('edit-product-price').value);
            const newQuantity = parseInt(document.getElementById('edit-product-quantity').value);
            const newEntryDate = document.getElementById('edit-product-entry-date').value;
            const newExpiryDate = document.getElementById('edit-product-expiry-date').value;
            const newCategory = document.getElementById('edit-product-category').value;
            const newCode = document.getElementById('edit-product-code').value.trim();
            
            if (!newName || isNaN(newPrice) || isNaN(newQuantity) || !newCode) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }
            
            // Verificar si el nuevo código ya existe en otro producto
            if (newCode !== code) {
                const existingProduct = appState.products.find(p => p.code === newCode);
                if (existingProduct) {
                    alert('Ya existe un producto con este código.');
                    return;
                }
            }
            
            // Actualizar producto
            appState.products[productIndex] = {
                code: newCode,
                name: newName,
                price: newPrice,
                quantity: newQuantity,
                entryDate: newEntryDate,
                expiryDate: newExpiryDate,
                category: newCategory
            };
            
            // Actualizar stock inicial si es mayor
            if (newQuantity > appState.initialStock[code]) {
                appState.initialStock[newCode] = newQuantity;
                delete appState.initialStock[code];
            }
            
            editProductModal.style.display = 'none';
            saveDataToStorage();
            renderCategories();
        }

        function deleteProduct(code) {
            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                appState.products = appState.products.filter(p => p.code !== code);
                
                // Eliminar de productsSold si existe
                for (let category in appState.productsSold) {
                    if (appState.productsSold[category][code]) {
                        delete appState.productsSold[category][code];
                    }
                }
                
                saveDataToStorage();
                renderCategories();
            }
        }

        // =============================================
        // 9. FUNCIONES DE CIERRE DE CAJA - TABLA RESPONSIVE
        // =============================================
        function toggleCashierPanel() {
            cashierPanel.classList.toggle('open');
            if (cashierPanel.classList.contains('open')) {
                updateCashierPanel();
            }
        }

        function updateCashierPanel() {
            updateProductsSoldUI();
            calculateCashTotals();
        }

        function updateProductsSoldUI() {
            productsSoldContent.innerHTML = '';
            
            if (Object.keys(appState.productsSold).length === 0) {
                productsSoldContent.innerHTML = '<p>No hay productos vendidos registrados.</p>';
                document.getElementById('total-sales').textContent = '0.00';
                return;
            }
            
            let grandTotal = 0;
            
            // Procesar cada categoría
            Object.keys(appState.productsSold).forEach(category => {
                let categoryTotal = 0;
                
                // Crear contenedor para la categoría
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'products-sold-container';
                
                // AJUSTE 1: Agregar nombre de categoría arriba de la tabla
                const categoryNameDiv = document.createElement('div');
                categoryNameDiv.className = 'category-name';
                categoryNameDiv.textContent = category;
                categoryContainer.appendChild(categoryNameDiv);
                
                // Crear tabla de productos vendidos
                const table = document.createElement('table');
                table.className = 'products-sold-table';
                
                // Encabezado de la tabla con 6 columnas
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Producto</th>
                        <th>Físico</th>
                        <th>Vendido</th>
                        <th>Restante</th>
                        <th>Precio</th>
                        <th>Importe</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                
                // Procesar cada producto en la categoría
                Object.keys(appState.productsSold[category]).forEach(productCode => {
                    const productData = appState.productsSold[category][productCode];
                    const currentProduct = appState.products.find(p => p.code === productCode);
                    const remaining = currentProduct ? currentProduct.quantity : 0;
                    const amount = productData.sold * productData.price;
                    categoryTotal += amount;
                    
                    const productRow = document.createElement('tr');
                    productRow.innerHTML = `
                        <td>${productData.name}</td>
                        <td>${productData.initialStock}</td>
                        <td>${productData.sold}</td>
                        <td>${remaining}</td>
                        <td>$${productData.price.toFixed(2)}</td>
                        <td>$${amount.toFixed(2)}</td>
                    `;
                    tbody.appendChild(productRow);
                });
                
                table.appendChild(tbody);
                categoryContainer.appendChild(table);
                
                // Fila de total de categoría
                const categoryTotalRow = document.createElement('div');
                categoryTotalRow.className = 'category-total-row';
                categoryTotalRow.innerHTML = `
                    <div style="padding: 10px; background-color: #f0f0f0; border-radius: 5px; text-align: right; font-weight: bold;">
                        Total ${category}: $${categoryTotal.toFixed(2)}
                    </div>
                `;
                categoryContainer.appendChild(categoryTotalRow);
                
                productsSoldContent.appendChild(categoryContainer);
                grandTotal += categoryTotal;
            });
            
            // Total general
            const grandTotalRow = document.createElement('div');
            grandTotalRow.className = 'grand-total-row';
            grandTotalRow.innerHTML = `
                <div style="padding: 10px; background-color: #d0d0d0; border-radius: 5px; text-align: right; font-weight: bold; font-size: 1.1rem;">
                    Total General: $${grandTotal.toFixed(2)}
                </div>
            `;
            productsSoldContent.appendChild(grandTotalRow);
            
            // Actualizar el total de ventas en el resumen de cierre
            document.getElementById('total-sales').textContent = grandTotal.toFixed(2);
        }

        function resetBreakdown() {
            if (confirm('¿Estás seguro de que quieres restablecer el desglose? Esto reiniciará todas las cantidades iniciales a las cantidades actuales y eliminará el historial de ventas.')) {
                // Establecer la cantidad inicial a la cantidad actual para cada producto
                appState.products.forEach(product => {
                    appState.initialStock[product.code] = product.quantity;
                });
                
                // Limpiar el historial de productos vendidos
                appState.productsSold = {};
                
                // Guardar cambios
                saveDataToStorage();
                
                // Actualizar la vista
                updateProductsSoldUI();
                
                alert('Desglose restablecido correctamente. Todos los productos restantes ahora son productos inicio.');
            }
        }

        // =============================================
        // 10. FUNCIONES DE GESTIÓN DE EFECTIVO
        // =============================================
        function updateCashBreakdownUI() {
            // Actualizar los inputs con los valores guardados
            document.getElementById('bill-1000').value = appState.cashBreakdown['bill-1000'];
            document.getElementById('bill-500').value = appState.cashBreakdown['bill-500'];
            document.getElementById('bill-200').value = appState.cashBreakdown['bill-200'];
            document.getElementById('bill-100').value = appState.cashBreakdown['bill-100'];
            document.getElementById('bill-50').value = appState.cashBreakdown['bill-50'];
            document.getElementById('bill-20').value = appState.cashBreakdown['bill-20'];
            document.getElementById('coin-10').value = appState.cashBreakdown['coin-10'];
            document.getElementById('coin-5').value = appState.cashBreakdown['coin-5'];
            document.getElementById('coin-1').value = appState.cashBreakdown['coin-1'];
            
            // Recalcular totales
            calculateCashTotals();
        }

        function calculateCashTotals() {
            const denominations = [
                { id: 'bill-1000', value: 1000, totalId: 'total-1000' },
                { id: 'bill-500', value: 500, totalId: 'total-500' },
                { id: 'bill-200', value: 200, totalId: 'total-200' },
                { id: 'bill-100', value: 100, totalId: 'total-100' },
                { id: 'bill-50', value: 50, totalId: 'total-50' },
                { id: 'bill-20', value: 20, totalId: 'total-20' },
                { id: 'coin-10', value: 10, totalId: 'total-coin-10' },
                { id: 'coin-5', value: 5, totalId: 'total-coin-5' },
                { id: 'coin-1', value: 1, totalId: 'total-coin-1' }
            ];
            
            let totalCash = 0;
            
            denominations.forEach(denom => {
                const quantity = parseInt(document.getElementById(denom.id).value) || 0;
                const total = quantity * denom.value;
                document.getElementById(denom.totalId).textContent = `$${total.toFixed(2)}`;
                totalCash += total;
                
                // Actualizar el estado
                appState.cashBreakdown[denom.id] = quantity;
            });
            
            document.getElementById('total-cash').textContent = totalCash.toFixed(2);
            
            // Calcular diferencia
            const totalSales = parseFloat(document.getElementById('total-sales').textContent) || 0;
            const difference = totalCash - totalSales;
            document.getElementById('cash-difference').textContent = difference.toFixed(2);
            
            // Colorear diferencia
            const differenceElement = document.getElementById('cash-difference');
            if (difference < 0) {
                differenceElement.style.color = '#e74c3c';
            } else if (difference > 0) {
                differenceElement.style.color = '#2ecc71';
            } else {
                differenceElement.style.color = '#333';
            }
            
            // Guardar el desglose actualizado
            saveDataToStorage();
        }

        function resetCashBreakdown() {
            if (confirm('¿Estás seguro de que quieres restablecer solo el desglose de efectivo? Todos los valores se pondrán en cero.')) {
                // Poner todos los inputs a cero
                document.getElementById('bill-1000').value = 0;
                document.getElementById('bill-500').value = 0;
                document.getElementById('bill-200').value = 0;
                document.getElementById('bill-100').value = 0;
                document.getElementById('bill-50').value = 0;
                document.getElementById('bill-20').value = 0;
                document.getElementById('coin-10').value = 0;
                document.getElementById('coin-5').value = 0;
                document.getElementById('coin-1').value = 0;
                
                // Actualizar el estado
                for (let key in appState.cashBreakdown) {
                    appState.cashBreakdown[key] = 0;
                }
                
                // Recalcular totales
                calculateCashTotals();
                
                alert('Desglose de efectivo restablecido correctamente.');
            }
        }

        // =============================================
        // 11. FUNCIONES DE REPORTES Y PDF
        // =============================================
        function generateCategoryBreakdownPDF() {
            const cashierName = cashierNameInput.value.trim();
            if (!cashierName) {
                alert('Por favor ingrese el nombre de quien realiza el cierre de caja antes de generar el PDF.');
                cashierNameInput.focus();
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración del documento
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let yPosition = margin;
            
            // Título
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Tienda La Reina", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 8;
            
            // Cajero
            doc.setFontSize(14);
            doc.text(`Cajero: ${cashierName}`, margin, yPosition);
            yPosition += 10;
            
            // Fecha y hora
            doc.setFontSize(12);
            doc.text(`Fecha y Hora: ${new Date().toLocaleString()}`, margin, yPosition);
            yPosition += 15;
            
            // Desglose por categoría
            // Agrupar productos por categoría
            const productsByCategory = {};
            appState.products.forEach(product => {
                const category = product.category || 'Sin categoría';
                if (!productsByCategory[category]) {
                    productsByCategory[category] = [];
                }
                productsByCategory[category].push(product);
            });
            
            // Renderizar cada categoría
            Object.keys(productsByCategory).forEach((category, index) => {
                // Verificar si necesita nueva página
                if (yPosition > doc.internal.pageSize.getHeight() - 50) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                // Título de categoría
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Categoría: ${category}`, margin, yPosition);
                yPosition += 10;
                
                // Tabla de productos
                const tableColumn = ["Producto", "Producto Inicio", "Producto Verificado"];
                const tableRows = [];
                
                productsByCategory[category].forEach(product => {
                    // MODIFICACIÓN 1: Mostrar la cantidad restante como "Producto Inicio"
                    const currentQty = product.quantity; // Cantidad actual (restante)
                    
                    tableRows.push([
                        product.name,
                        currentQty.toString(), // Mostramos la cantidad restante como "Producto Inicio"
                        "" // Producto Verificado (vacío)
                    ]);
                });
                
                // Generar la tabla
                doc.autoTable({
                    startY: yPosition,
                    head: [tableColumn],
                    body: tableRows,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [52, 152, 219],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    margin: { top: yPosition }
                });
                
                yPosition = doc.lastAutoTable.finalY + 10;
            });
            
            // Guardar el PDF
            doc.save(`desglose_categorias_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // =============================================
        // 12. FUNCIÓN MODIFICADA: ELIMINADA LA FUNCIÓN DE WHATSAPP
        // =============================================
        function sendWhatsApp() {
            const cashierName = cashierNameInput.value.trim();
            if (!cashierName) {
                alert('Por favor ingrese el nombre de quien realiza el cierre de caja antes de enviar el reporte.');
                cashierNameInput.focus();
                return;
            }

            // Generar el PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración del documento
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let yPosition = margin;
            
            // Título
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Tienda La Reina", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 8;
            
            // Subtítulo
            doc.setFontSize(16);
            doc.text("Cierre de Caja", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Cajero, fecha y hora
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Cajero: ${cashierName}`, margin, yPosition);
            yPosition += 6;
            doc.text(`Fecha y Hora: ${new Date().toLocaleString()}`, margin, yPosition);
            yPosition += 15;
            
            // Productos vendidos por categoría
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Productos Vendidos por Categoría", margin, yPosition);
            yPosition += 10;
            
            // Tabla de productos
            const tableColumn = ["Producto", "Inicial", "Vendido", "Restante", "Precio", "Importe"];
            const tableRows = [];
            
            let grandTotal = 0;
            
            // Procesar cada categoría
            Object.keys(appState.productsSold).forEach(category => {
                let categoryTotal = 0;
                let hasProducts = false;
                
                // Procesar cada producto en la categoría
                Object.keys(appState.productsSold[category]).forEach(productCode => {
                    const productData = appState.productsSold[category][productCode];
                    const currentProduct = appState.products.find(p => p.code === productCode);
                    const remaining = currentProduct ? currentProduct.quantity : 0;
                    const amount = productData.sold * productData.price;
                    categoryTotal += amount;
                    
                    tableRows.push([
                        productData.name,
                        productData.initialStock.toString(),
                        productData.sold.toString(),
                        remaining.toString(),
                        `$${productData.price.toFixed(2)}`,
                        `$${amount.toFixed(2)}`
                    ]);
                    hasProducts = true;
                });
                
                if (hasProducts) {
                    // Agregar subtotal de categoría
                    tableRows.push([
                        `TOTAL ${category}`,
                        "",
                        "",
                        "",
                        "",
                        `$${categoryTotal.toFixed(2)}`
                    ]);
                    
                    // Línea divisoria
                    tableRows.push(["", "", "", "", "", ""]);
                    
                    grandTotal += categoryTotal;
                }
            });
            
            // Agregar total general
            tableRows.push([
                "TOTAL GENERAL",
                "",
                "",
                "",
                "",
                `$${grandTotal.toFixed(2)}`
            ]);
            
            // Generar la tabla
            doc.autoTable({
                startY: yPosition,
                head: [tableColumn],
                body: tableRows,
                theme: 'grid',
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                },
                margin: { top: yPosition }
            });
            
            yPosition = doc.lastAutoTable.finalY + 15;
            
            // Desglose de efectivo
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Desglose de Efectivo", margin, yPosition);
            yPosition += 10;
            
            // Tabla de efectivo
            const cashTableColumn = ["Denominación", "Cantidad", "Total"];
            const cashTableRows = [];
            
            const denominations = [
                { id: 'bill-1000', value: 1000, name: '$1000' },
                { id: 'bill-500', value: 500, name: '$500' },
                { id: 'bill-200', value: 200, name: '$200' },
                { id: 'bill-100', value: 100, name: '$100' },
                { id: 'bill-50', value: 50, name: '$50' },
                { id: 'bill-20', value: 20, name: '$20' },
                { id: 'coin-10', value: 10, name: ' $10' },
                { id: 'coin-5', value: 5, name: ' $5' },
                { id: 'coin-1', value: 1, name: '$1' }
            ];
            
            let cashTotal = 0;
            
            denominations.forEach(denom => {
                const quantity = parseInt(document.getElementById(denom.id).value) || 0;
                if (quantity > 0) {
                    const total = quantity * denom.value;
                    cashTotal += total;
                    cashTableRows.push([
                        denom.name,
                        quantity.toString(),
                        `$${total.toFixed(2)}`
                    ]);
                }
            });
            
            // Agregar total de efectivo
            cashTableRows.push([
                "TOTAL EFECTIVO",
                "",
                `$${cashTotal.toFixed(2)}`
            ]);
            
            // Generar la tabla de efectivo
            doc.autoTable({
                startY: yPosition,
                head: [cashTableColumn],
                body: cashTableRows,
                theme: 'grid',
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                }
            });
            
            yPosition = doc.lastAutoTable.finalY + 15;
            
            // Resumen de cierre
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Resumen de Cierre", margin, yPosition);
            yPosition += 10;
            
            const difference = cashTotal - grandTotal;
            let differenceText = `Diferencia: $${difference.toFixed(2)}`;
            
            if (difference < 0) {
                differenceText += " (FALTANTE)";
            } else if (difference > 0) {
                differenceText += " (SOBRANTE)";
            } else {
                differenceText += " (EXACTO)";
            }
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Total en Efectivo: $${cashTotal.toFixed(2)}`, margin, yPosition);
            yPosition += 7;
            doc.text(`Total de Ventas: $${grandTotal.toFixed(2)}`, margin, yPosition);
            yPosition += 7;
            doc.text(differenceText, margin, yPosition);
            
            // Convertir PDF a Blob
            const pdfBlob = doc.output('blob');
            
            // Descargar el PDF automáticamente
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const downloadLink = document.createElement('a');
            downloadLink.href = pdfUrl;
            downloadLink.download = `cierre_caja_${new Date().toISOString().slice(0, 10)}.pdf`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Limpiar URL después de un tiempo
            setTimeout(() => {
                URL.revokeObjectURL(pdfUrl);
            }, 1000);
            
            alert('PDF de cierre de caja descargado correctamente.');
        }

        // =============================================
        // 13. FUNCIONES DE NOTIFICACIÓN
        // =============================================
        function showScanNotification(message, type = 'success') {
            // Crear elemento de notificación si no existe
            let notification = document.getElementById('scan-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'scan-notification';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.padding = '15px 20px';
                notification.style.borderRadius = '5px';
                notification.style.color = 'white';
                notification.style.zIndex = '9999';
                notification.style.transition = 'all 0.3s ease';
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                document.body.appendChild(notification);
            }
            
            // Configurar notificación
            notification.textContent = message;
            notification.style.background = type === 'success' ? '#4CAF50' : '#f44336';
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
            }, 3000);
            
            // Reproducir sonido de notificación
            const scanSound = document.getElementById('scanSound');
            if (scanSound) {
                scanSound.currentTime = 0;
                scanSound.play().catch(e => console.log("Error reproduciendo sonido:", e));
            }
        }

        // =============================================
        // 14. HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // =============================================
        window.removeFromInvoice = removeFromInvoice;
        window.adjustInvoiceQuantity = adjustInvoiceQuantity;
        window.deleteCategory = deleteCategory;
        window.toggleAddProductForm = toggleAddProductForm;
        window.startCategoryScanner = startCategoryScanner;
        window.addProductToCategoryFromCode = addProductToCategoryFromCode;
        window.saveProductToCategory = saveProductToCategory;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.resetCashBreakdown = resetCashBreakdown;
        window.generateCategoryBreakdownPDF = generateCategoryBreakdownPDF;
    </script>
</body>
</html>


